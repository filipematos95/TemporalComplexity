#### Load packages ####
setwd("~/dades/chaos/fluxchaos")
library (nonlinearTseries)
library (tseriesChaos)
library (plot3D)
library (deSolve) #ODE solver package
library (mblm)
library (fields)
library (doParallel)
library (snow)
#### Load functions ####
date.fun <- function(date.fluxnet){
  return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
}
embed_udf <-function(x, mmax=6, d=NA){
  if(is.na(d)){
    #Step 1: Calculate embedding delay
    #Step 1a. Compute average mutual information (AMI) function
    mutual.out<-mutual(x, lag.max=100, plot=F) #mutual(tseriesChaos)
    #Step 1b: Use embedding approach to calculate delay at which AMI hits
    #its first minimum
    mutual.em<-embedd(mutual.out,2,1) #embedd(tseriesChaos)
    mutual.adj.length<-length(mutual.out)-1 #lose 1 observation to delay
    mutual.hold<-matrix(0,mutual.adj.length,1)
    for (i in 1:mutual.adj.length){ #loop to compute successfive value differences
      mutual.test<-if(mutual.em[i,1]>mutual.em[i,2])TRUE else break
      mutual.hold[i,1]<-mutual.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
    } #end iloop
    mutual.hold.sum<-sum(mutual.hold)
    #Step 1c: Estimate embeddeding delay (d). If the mutual information function is
    #decreasing across all 100 delays, set delay at max = 100
    d<-if(mutual.hold.sum<100)mutual.hold.sum else 100 #Embedding delay
  }
  #Step 2: Compute Theiler window parameter (tw) required for false nearest
  # neighbours test
  #Step 2a: Autocorrelation function
  lag.max=100
  acf.run<-acf(x,lag.max, plot=F)
  acf.out<-acf.run$acf #array of acf values
  #Step 2b: Use embedding approach to calculate delay at which AMI hits
  #its first minimum.
  acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
  acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
  acf.hold<-matrix(0,acf.adj.length,1)
  for (i in 1:acf.adj.length){ #loop to compute successfive value differences
    acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
    acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
  } #end iloop
  #Step 2c: Estimate Theiler window (tw)
  tw<-sum(acf.hold)
  #Step 3: Embedding dimension (m)
  #Step 3a: False nearest neighbours function
  m.max<-mmax #maximum number of embedding dimensions to consider
  fn.out<-false.nearest(x,m.max,d,tw) #false.nearest(tseriesChaos)
  fn.out[is.na(fn.out)] <- 0 #set NA in fn.out to zero
  #plot(fn.out)
  #Step 3b: Find delay at which false nearest neighbours decrease below set tolerance
  #Output vector of fnn percentages from fn.out
  fnp<-c(fn.out[1],fn.out[3],fn.out[5],fn.out[7],fn.out[9],fn.out[11])
  fnp.tol<-fnp>0.15 #If fnp greater than tolerance of 15%, T entered into fnp.tol
  fnp.tol.sum<-sum(fnp.tol) #sum up number of T's
  m<-if(fnp.tol.sum<m.max)fnp.tol.sum+1 else m.max #Embedding dimension
  #Step 4: Embed time series (Mx)
  #If m=1, embedd routine crashes due to 'subscript out of bounds' error--need to
  #guarantee an embedding dimension of at least two:
  if(m<=1){m<-2} else {m}
  Mx<-embedd(x,m,d) #embedd(tseriesChaos)
  #Results
  results.embed_udf<-list(d,m,tw,Mx)
  return(results.embed_udf)
} # modified from NLTS analysis book
attract2d <- function(var, lag, type="p", cex=0.5, col="red", burn=0){
  if(burn!=0){
    aux <- embedd(var[-c(1:burn)],3,lag)} else {aux <- embedd(var,3,lag)}
  plot(x=aux[,1],y=aux[,2], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", cex.symbols=cex)
}
attract <- function(var, lag, type="p", bty="b2", ..., phi = 10, theta = 20, add=F, pch=NULL, lwd=NULL, cex=0.5, col="red", alpha=1, burn=0, xlim=NULL, ylim=NULL, zlim=NULL){
  if(burn!=0){
    aux <- embedd(var[-c(1:burn)],3,lag)} else {aux <- embedd(var,3,lag)}
  # scatterplot3d(x=aux[,1],y=aux[,2],z=aux[,3], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), cex.symbols=cex, xlim=xlim, ylim=ylim, zlim=zlim)
  scatter3D(x=aux[,1],y=aux[,2],z=aux[,3], ..., add=add, alpha = alpha, ticktype = "detailed", type=type, bty= bty, lwd=lwd, cex=cex, pch=pch, phi = phi, theta = theta, col = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), xlim=xlim, ylim=ylim, zlim=zlim)
}
attract.or <- function(var, type="p", bty="b2", ..., phi = 10, theta = 20, add=F, pch=NULL, lwd=NULL, cex=0.5, col="red", alpha=1, burn=0, xlim=NULL, ylim=NULL, zlim=NULL){
  if(burn!=0){
    var <- var[-c(1:burn), ]}
  # scatterplot3d(x=aux[,1],y=aux[,2],z=aux[,3], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), cex.symbols=cex, xlim=xlim, ylim=ylim, zlim=zlim)
  scatter3D(x=var[,1],y=var[,2],z=var[,3], ..., add=add, alpha = alpha, ticktype = "detailed", type=type, bty= bty, lwd=lwd, cex=cex, pch=pch, phi = phi, theta = theta, col = col, ylab=paste("PC2"), xlab="PC1", zlab=paste("PC3"), xlim=xlim, ylim=ylim, zlim=zlim)
}

lorenz_udf<-function(x0,y0,z0,sigma,beta,rho,t.end,delta) {
  #Initial conditions and parameters
  state<-c(x=x0,y=y0,z=z0) #initial conditions
  parameters<-c(sigma,beta,rho) #parameters giving chaotic dynamics
  #ODE model
  model<-function(t,state,parameters){
    with(as.list(c(state,parameters)),{
      dx<- sigma*(y-x) #Lorenz equations
      dy<- x*(rho-z)-y
      dz<- x*y-beta*z
      list(c(dx,dy,dz))
    }) #end with (as.list...
  } #end model function
  #Solution
  times<-seq(0,t.end,by=delta) #integration step
  out<-ode(y=state,times=times,func=model,parms=parameters,method="lsoda")
  #Solution variables
  x<-out[,"x"];y<-out[,"y"];z<-out[,"z"]
  results<-list(x,y,z)
  return(results)
} #end user-defined function
plot_c <- function(M,y1= 0.00000001,y2 = 1, xlim=NULL, ylab=NULL, xlab=NULL, main=NULL ){

  plot(M[,1],M[,2],log="xy",ylim=c(y1,y2),type="l", xlim=xlim, ylab=ylab, xlab=xlab, main=main, las=1)
  for(i in c(2:ncol(M))) lines(M[,1],M[,i])

}
plot_b <- function(M,y1= 0.00000001,y2 = 1, xlim=NULL, ylab=NULL, xlab=NULL, main=NULL ){

  plot(M[,1],M[,2],ylim=c(y1,y2),type="l", xlim=xlim, ylab=ylab, xlab=xlab, main=main, las=1)
  for(i in c(2:ncol(M))) lines(M[,1],M[,i])

}

## Information dimension function ##
pv.fun1 <- function(var1){
  var <- na.omit(var)
  if(var1[1]==var1[2]){return(0)}else{
    return((1-(min(var1[1],var1[2])/max(var1[1],var1[2]))))}
}
pv.fun <- function(var){
  var <- na.omit(var)
  if(length(var)<2){return(NA)} else {
    return(mean(as.numeric(combn(var, 2, FUN = pv.fun1, simplify = F))))}}
id.calc <- function(d, add=0, rang=20, prop.rang.max=1, prop.rang.min=1,
                    ttail=5, cut=0.99, cut.low=0.01, w.var=0.5, dims=NA, correction="loess"){
  # initialise
  # add <- 1
  # rang <- 20
  # prop.rang.max <- 1
  # prop.rang.min <- 1
  # ttail <- 5
  # cut <- 0.99 # cut values of density higher than...
  # cut.low <- 0.01 # cut values of density lower than...
  # w.var <- 0.35 # weigh of variability vs. Rsq, 0.5 is equal contribution
  # dims <- 1:30
  # set up M matrix for analysis
  # plot_c(M,y1 = 1e-02, y2=14)
  # plot_c(cbind(M[,1],1/exp(M[,-c(1:6)])), y1 = 0.0000001, y2=1)
  # plot_c(M[,-c(2:6)], y1=8, y2=15, xlim=c(0.05,1))
  temp <- t(as.matrix(d$log.radius))
  if(!is.numeric(dims[1])){dims <- 1:(ncol(temp)-1)}
  p <- as.numeric(row.names(temp))
  M <- matrix(nrow=length(temp[,1]),ncol=length(temp[1,])+2)
  M[,1] <- p;M[,2] <- 0
  for(j in c(3:length(M[1,]))) M[,j] <- 10^(temp[,j-2])
  # plot_c(cbind(M[,1],1/M[,2:ncol(M)]), y1 = 0.1, y2=10)
  # calculate p at which variability betwen dimensions is lower #
  M <- M[,c(1,(dims+1))]
  M <- subset(M, (M[,1]<cut)&(M[,1]>cut.low))
  # var.row <- 1-apply(M[,-c(1:3)], MARGIN = 1, FUN=pv.fun)
  # var.row <- var.row/max(var.row,na.rm=T)
  # plot(var.row)
  ### starts running
  rang <- round(rang,digit=0)
  ttail <- round(ttail, digit=0)
  prop.rang <- seq(prop.rang.max, prop.rang.min, length=(ncol(M)-1))
  sel <- list()
  cdims <- data.frame(embdim=c(1:(ncol(M)-1)),id=rep(NA,times=(ncol(M)-1)), eps=NA, rsq=NA, locus=NA)
  b <- matrix(ncol=(ncol(M)-1), nrow=nrow(M))
  c <- b # check correlations
  bbb <- b # matrix for slopes
  ccc <- b
  M[M==0] <- NA
  for (i in 1:(ncol(M)-1)){
    for (j in (rang+1):(nrow(M)-rang)){
      if (length(which(is.na(M[(j-rang):(j+rang),(i+1)])))>=(rang/2)){b [j,i] <- NA} else {
        # b [j,i] = summary(lm(log(M[(j-rang):(j+rang),(i+1)])~ log(M[(j-rang):(j+rang),1])))$r.squared # to use local Rsq
        bbb [j,i] = 1-summary(lm(log(M[(j-rang):(j+rang),(i+1)])~ log(M[(j-rang):(j+rang),1])))$coefficients[2,1]
        b [j,i] <- bbb [j,i]} # to use local slope
    }
  }

  # calculate variability between rows (1-pv= stability)
  var.row <- 1-apply(b[,-c(1:3)], MARGIN = 1, FUN=pv.fun) # estimate stability (1-PV)
  var.row [is.infinite(var.row)] <- NA
  var.row <- as.numeric((scale(var.row)+(abs(min(scale(var.row), na.rm=T))+1))/max(scale(var.row)+(abs(min(scale(var.row), na.rm=T))+1),na.rm=T))

  for (i in 1:(ncol(M)-1)){
    c [,i] <- b[,i]
    ccc [,i] <- bbb[,i]
    # b [,i] <- b[,i]*(1-w.var) * (var.row*w.var) # multiplicative weighting
    b [,i] <- b[,i]*(1-w.var) + (var.row*w.var) # additive weighting
    if (length(which(!is.na(b[,i])))<5){} else {
      cdims$rsq [i] <- max(b[,i],na.rm=T) # maximum rsq
      cdims$locus[i]<- (which(b[,i]==cdims$rsq[i])) # place max rsq
      cdims$eps [i] <- M[cdims$locus[i],1] # epsilon of max rsq
      sel[[i]] <- c((cdims$locus[i]-(round(rang*prop.rang[i],0))):(cdims$locus[i]+(round(rang*prop.rang[i],0))))
      cdims$id [i] <- 1/as.numeric(lm(log(M[sel[[i]],(i+1)]) ~ log(M[sel[[i]],1]))$coef[2])
    }
  }


  ## correcting selection ##
  sel.c <- list()
  if(correction=="none"){cdims$locus.c <- cdims$locus} # no correction
  if(correction=="loess"){cdims$locus.c <- cdims$locus
    cdims$locus.c [!is.na(cdims$id)] <- round(predict(loess(locus ~ embdim, data=cdims, span=1)),0)} # loess correction
  if(correction=="constant"){cdims$locus.c <- cdims$locus
    cdims$locus.c [(nrow(cdims)-ttail+1):nrow(cdims)] <- cdims$locus.c [(nrow(cdims)-ttail+1)]} # constant epsilon correction
  if(correction=="increasing"){cdims$locus.c <- cdims$locus
    cdims$locus.c [(nrow(cdims)-ttail+1):nrow(cdims)] <- round(seq(cdims$locus.c [(nrow(cdims)-ttail+1)], cdims$locus.c [(nrow(cdims)-ttail+1)] + add, length=ttail),0)} # constant increasing/decreasing epsilon correction
  for (i in 1:(nrow(cdims))){
    if(is.na(cdims$locus.c[i])){
      sel.c[[i]]<-NA
      cdims$rsq.c [i] <- NA
      cdims$eps.c [i] <- NA
      cdims$id.c [i] <- NA} else {
      cdims$rsq.c [i] <- b[cdims$locus.c [i],i]
      cdims$eps.c [i] <- M[cdims$locus.c [i],1]
      sel.c[[i]] <- c((cdims$locus.c[i]-(round(rang*prop.rang[i],0))):(cdims$locus.c[i]+(round(rang*prop.rang[i],0))))
      cdims$id.c [i] <- 1/as.numeric(lm(log(M[sel.c[[i]],(i+1)]) ~ log(M[sel.c[[i]],1]))$coef[2])
    }
  }


  par(mfrow=c(4,1), mar=c(3,4.5,1,1))
  # plot_c(cbind(M[,1],c*100), y1 = 85, y2=(max(c*100,na.rm=t)+5), ylab="R-squared", xlim=c(0.05,1))
  # plot_c(cbind(M[,1],b*100), y1 = 85, y2=(max(b*100,na.rm=t)+5), ylab="R-squared*Var", xlim=c(0.05,1))
  plot_c(cbind(M[,1],c*100), y1 = 80, y2=(max(c*100,na.rm=t)+5), ylab="Ln-Ln Slope", xlim=c(0.03,1))
  plot_c(cbind(M[,1],b*100), y1 = 80, y2=100, ylab="Ln-Ln Slope*Var", xlim=c(0.03,1))
  for (i in 2:nrow(cdims)){
    lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ M[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
  }
  points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
  points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
  plot(id~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Info. dimension (id)", xlab="Embeddng dimension")
  plot(id.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Info. dimension (id)", xlab="Embeddng dimension")

  mm <-summary.lm(mblm(id.c ~ embdim, data=cdims[(nrow(cdims)-ttail+1):nrow(cdims),], repeated=T))$coefficients[2,c(1,2,4)]
  id <- data.frame(id=mean(cdims$id.c[(nrow(cdims)-ttail+1):nrow(cdims)]),id.se=sd(cdims$id.c[(nrow(cdims)-ttail+1):nrow(cdims)])/sqrt(ttail))

  lines(rep(id$id,ttail) ~ c((nrow(cdims)-ttail+1):nrow(cdims)), lwd=4, col="blue")

  if(mm[3]>=0.05){
    cond <- paste("Plateau reached at ", round(id$id,2), " +/- ", round(id$id.se,2), "; Pval=", round(mm[3],5), sep="")
  } else {
    cond <- paste("Plateau was not reached, sorry... ", round(id$id,2), " +/- ", round(id$id.se,2), "; Pval=", round(mm[3],5), sep="")
  }
  print(cond)


  # based on density function
  aux <- numeric()
  for (z in 2:ncol(ccc)){
    # plot(density(na.omit(c[,z]), bw = 0.02), xlim=c(0.5,1))
    a <- density(na.omit(ccc[,z]), bw = 0.02)
    a$y <- a$y[a$x>(0.6)&a$x<(1)]
    a$x <- a$x[a$x>(0.6)&a$x<(1)]
    aa <- data.frame(x=a$x, y=a$y)
    aa <- aa[order(aa$x, decreasing = T),]
    aaa <- data.frame(embedd(aa$y, d=1, m=2))
    aaa [(nrow(aaa)+1), c(1,2)] <- NA
    aaa$res <- aaa$V1.1 -aaa$V1.0
    aa <- cbind(aa, aaa)
    site <- aa$x[which(aa$res<0)][1]
    if (class(site)=="integer"){site <- aa$x[which(aa$y==max(aa$y))]}
    aux [z] <- 1/(1-site)
  }

  aabb <- data.frame(a=aux[(length(aux)-4):length(aux)], b=c(1:5))
  mm <-summary.lm(mblm(a ~ b,dataframe = aabb, repeated=T))$coefficients[2,c(1,2,4)]
  aux2 <- data.frame(id=mean(aux[(length(aux)-4):length(aux)]),se=sd(aux[(length(aux)-4):length(aux)])/sqrt(5), pval=as.numeric(mm[3]))
  par(mfrow=c(2,1), mar=c(3,4.5,1,1))
  plot(aux, pch=21, bg="red", las=1, ylab="Info. Dimension (D1)", xlab="Embedding dimension")
  lines(rep(aux2$id,5) ~ c((max(dims)-4):max(dims)), col="blue", lwd=2)
  plot_c(cbind(M[,1],(1/(1-ccc[,-1]))), y1 = 0.5, y2=(max((1/(1-ccc[,-1])),na.rm=t)+0.5), ylab="Ln-Ln Slope", xlim=c(0.03,1))
  return(list(slopes= cbind(M[,1],(1/(1-ccc[,-1]))), rsq.method=cbind(id,pval=round(mm[3],5)), dens.method=aux2))
}
## Correlation dimension function ##
cd.calc <- function(d, exp.smooth=F, add=0, rang=100, prop.rang.max=0.5, prop.rang.min=0.5, ttail=5, dims=NA, w.var=0.5, tails=F, nontails=13:18, correction="loess"){ # correction="loess", "constant", "increasing"
  # add <- 0 # try 100 for nee
  # rang <- 10 # fix 100 for nee
  # prop.rang.max <- 0.5 # 0.5 equals rang*2 + 1
  # prop.rang.min <- 0.5
  # ttail <- 5
  # w.var <- 0.5 # variability weight, 0.5 means equal
  if(is.na(dims[1])){dims <- 1:(ncol(d)-1)}
  # tails <- F
  # nontails <- c(13:17)
  if(tails == F) {cttail <- ((length(dims)-ttail+1):length(dims))} else {cttail <- nontails}

  ## smooth scalling exponents?
  if(exp.smooth==T){
    for (i in 1:ncol(d)){
      d[,i] <- predict(loess(d[,i]~c(1:length(d[,i])),span = 0.15))
    }
  }

  ### starts running
  x <- d[,c(1,(dims+1))]
  rang <- round(rang,digit=0)
  ttail <- round(ttail, digit=0)
  prop.rang <- seq(prop.rang.max, prop.rang.min, length=(ncol(x)-1))
  sel <- list()
  cdims <- data.frame(embdim=c(1:(ncol(x)-1)),d2=rep(NA,times=(ncol(x)-1)), eps=NA, rsq=NA, locus=NA)
  b <- matrix(ncol=(ncol(x)-1), nrow=nrow(x))
  c <- b
  f <- matrix(ncol=ncol(c), nrow=nrow(c))
  f[,c(1,2)] <- 0
  x[x==0] <- NA
  for (i in 1:(ncol(x)-1)){
    for (j in (rang+1):(nrow(x)-rang)){
      if (length(which(is.na(x[(j-rang):(j+rang),(i+1)])))>=(rang/2)){b [j,i] <- NA} else {
        md <- summary(lm(log(x[(j-rang):(j+rang),(i+1)])~ log(x[(j-rang):(j+rang),1])))
        b [j,i] = md$r.squared
        c [j,i] = md$coefficients[2,1]}
    }
  }

  # for (y in 2:ncol(c)){
  #   f [,y] <- abs(c[,y]-c[,y-1])/c[,y-1]
  # } # substraction

  # calculate variability (estability=1-PV) per epsilon for ech band
  for (i in 3:ncol(c)){
    for (w in 1:nrow(c)){
      if(any(is.na(c(c[w,i],c[w,i-1],c[w,i-2])))) {f [w,i] <- 0} else
      {f [w,i] <- pv.fun(c(c[w,i],c[w,i-1],c[w,i-2]))}
    }
  } # PV 3 bands

  # # calculate stability (1-PV) per epsilon all bands together
  # for (w in 1:nrow(c)){
  #   if(any(is.na(c(c[w,])))) {f [w,1] <- NA} else
  #   {f [w,1] <- pv.fun(c(c[w,]))}
  # }# PV all bands
  # f [,-1] <- f[,1]

  # correct matrices for var.weight
  f <- (1-f)*w.var # convert to stability
  summary (f)
  b <- b*(1-w.var)

  # selection of site
  for (i in 1:(ncol(x)-1)){
    # b[!is.finite(b[,i]),i] <- NA
    # maximum of the series
    cdims$rsq [i] <- max((f[,i])+b[,i],na.rm=T) # maximum rsq
    cdims$locus[i]<- (which((f[,i])+b[,i]==cdims$rsq[i])) # place max rsq
    cdims$eps [i] <- x[cdims$locus[i],1] # epsilon of max rsq
    sel[[i]] <- c((cdims$locus[i]-(round(rang*prop.rang[i],0))):(cdims$locus[i]+(round(rang*prop.rang[i],0))))
    cdims$d2 [i] <- as.numeric(lm(log(x[sel[[i]],(i+1)]) ~ log(x[sel[[i]],1]))$coef[2])
  }

  ## correcting selection ##
  sel.c <- list()
  cdims$locus.c <- round(predict(loess(locus ~ embdim, data=cdims, span=1)),0) # smooth-only correction
  if(correction=="loess"){cdims$locus.c <- cdims$locus} # no correction
  if(correction=="constant"){cdims$locus.c [(ncol(b)-ttail+1):ncol(b)] <- cdims$locus.c [(ncol(b)-ttail+1)]} # constant epsilon correction
  if(correction=="increasing"){cdims$locus.c [(ncol(b)-ttail+1):ncol(b)] <- round(seq(cdims$locus.c [(ncol(b)-ttail+1)], cdims$locus.c [(ncol(b)-ttail+1)] + add, length=ttail),0)} # constant increasing/decreasing epsilon correction
  for (i in 1:(ncol(x)-1)){
    cdims$rsq.c [i] <- b[cdims$locus.c [i],i]+(f[cdims$locus.c [i],i])
    cdims$eps.c [i] <- x[cdims$locus.c [i],1]
    sel.c[[i]] <- c((cdims$locus.c[i]-(round(rang*prop.rang[i],0))):(cdims$locus.c[i]+(round(rang*prop.rang[i],0))))
    cdims$d2.c [i] <- as.numeric(lm(log(x[sel.c[[i]],(i+1)]) ~ log(x[sel.c[[i]],1]))$coef[2])
  }


  # D2 based on density function
  aux <- numeric()
  dims <- dims
  lim <- 0.05
  L <- c; L[L<lim] <- NA; L <- na.omit(L)
  for (z in 3:length(dims)){
    # plot(density(na.omit(c[,z]), bw = 0.08))
    a <- density(L[,(z-2):z], bw = 0.07)
    aa <- data.frame(x=a$x, y=a$y)
    # for first maximum density
    # aa <- aa[order(aa$x, decreasing = T),]
    # aaa <- data.frame(embedd(aa$y, d=2, m=2))
    # aaa [(nrow(aaa)+1):(nrow(aaa)+2), c(1,2)] <- NA
    # aaa$res <- round((aaa$V1.2 - aaa$V1.0)/aaa$V1.0, digit=3)
    # aa <- cbind(aa, aaa)
    # site <- aa$x[which(aa$res<(-0.01))][1] # chosing first maximum
    # if (class(site)=="integer"){site <- aa$x[which(aa$y==max(aa$y))]}
    # for maximum density
    site <- aa$x[which(aa$y==max(aa$y))] # slope at maximum density
    aux [z] <- site

    if (z==length(dims)){
      t <- density(L, bw = 0.08)
      tt <- data.frame(x=t$x, y=t$y)
      # for first maximum
      # tt <- tt[order(tt$x, decreasing = T),]
      # ttt <- data.frame(embedd(tt$y, d=2, m=2))
      # ttt [(nrow(ttt)+1):(nrow(ttt)+2), c(1,2)] <- NA
      # ttt$res <- round((ttt$V1.2 - ttt$V1.0)/ttt$V1.0, digit=3)
      # tt <- cbind(tt, ttt)
      # autt <- mean(tt$x[(which(tt$res<(-0.01))[1]-2):(which(tt$res<(-0.01))[1]+2)])
      # autt.se <- sd(tt$x[(which(tt$res<(-0.01))[1]-2):(which(tt$res<(-0.01))[1]+2)])/sqrt(5)
      # if (class(site)=="integer"){autt <- tt$x[which(tt$y==max(tt$y))]}

      # for maximum density
      autt <- mean(tt$x[(which(tt$y==max(tt$y))-2):(which(tt$y==max(tt$y))+2)])
      autt.se <- sd(tt$x[(which(tt$y==max(tt$y))-2):(which(tt$y==max(tt$y))+2)])/sqrt(5)
    }
  }
  aabb <- data.frame(a=aux[(length(aux)-4):length(aux)], b=c(1:5))
  mm <-summary.lm(mblm(a ~ b,dataframe = aabb, repeated=T))$coefficients[2,c(1,2,4)]
  aux2 <- data.frame(cd=c(mean(aux[(length(aux)-4):length(aux)]),autt),se=c(sd(aux[(length(aux)-4):length(aux)])/sqrt(5),autt.se), pval=c(as.numeric(mm[3]),NA))
  rownames(aux2) <- c("Single", "Overall")

  ## minimum slope (5) ##
  slataux <- NA
  plataux <- NA
  for (i in 5:length(cdims$embdim)){
    aaa <- summary.lm(mblm(d2.c ~ embdim,dataframe = cdims[c((i-4):i),], repeated=T))$coefficients[2,]
    slataux[i] <- abs(as.numeric(aaa[1]))
    plataux[i] <- as.numeric(aaa[4])
  }
  d2.minslope <- mean(cdims$d2.c[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])
  d2.minslope.se <- sd(cdims$d2.c[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])/sqrt(5)
  d2.minslope.p <- plataux[which(slataux==min(slataux, na.rm=T))]

  # graphic output
  par(mfrow=c(5,1), mar=c(3,4.5,1,1))
  plot_b(na.omit(cbind(x[,1],(b+f)*100)), y1 = 60, y2=100, ylab="R-squared x Stability (1-PV)")
  for (i in 2:nrow(cdims)){
    lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ x[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
  }
  points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
  points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
  plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
  plot(d2~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Correlation dimension (D2)", xlab="Embeddng dimension")
  plot(d2.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Corrected D2", xlab="Embeddng dimension")

  # estimate density of D2
  dn <- density(cdims$d2.c);dn <- dn$x[which(dn$y==max(dn$y))]
  # estimate CD
  mm <-summary.lm(mblm(d2.c ~ embdim, data=cdims[cttail,], repeated=T))$coefficients[2,c(1,2,4)]
  d2 <- data.frame(d2=mean(cdims$d2.c[cttail]),d2.se=sd(cdims$d2.c[cttail])/sqrt(length(cttail)))
  # plot line on graph
  lines(rep(d2$d2,length(cttail)) ~ cttail, lwd=4, col="blue")
  lines(rep(dn,length(dims)) ~ c(1:length(dims)), lwd=4, col="black")
  lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

  # Plot density estimation of D2
  plot(aux, pch=21, bg="red", las=1, ylab="Corr. Dimension (D2)", xlab="Embedding dimension")
  lines(rep(aux2$cd[1],5) ~ c((length(dims)-4):length(dims)), col="blue", lwd=2)
  lines(rep(aux2$cd[2],length(1:max(dims))) ~ c(1:max(dims)), col="blue", lwd=2)

  # print message
  if(mm[3]>=0.05){
    cond <- paste("End plateau reached at ", round(d2$d2,2), " +/- ", round(d2$d2.se,2), "; Pval=", round(mm[3],5), sep="")
  } else {
    cond <- paste("End plateau was not reached, sorry... ", round(d2$d2,2), " +/- ", round(d2$d2.se,2), "; Pval=", round(mm[3],5), sep="")
  }
  print(cond)

  # print message previous plateau?
  if(d2.minslope.p>=0.05){
    cond <- paste("Min slope plateau reached at ", round(d2.minslope,2), " +/- ", round(d2.minslope.se,2), "; Pval=", round(d2.minslope.p,5), sep="")
  } else {
    cond <- paste("Plateau was not reached, minimum slope at ", round(d2.minslope,2), " +/- ", round(d2.minslope.se,2), "; Pval=", round(d2.minslope.p,5), sep="")
  }
  print(cond)

  ##print result rsq method
  # cbind(d2,pval=round(mm[3],5), dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1))
  ## print results density estimation of D2
  # cbind(aux2[1,], aux2[2,-3], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))
  par(mfrow=c(1,1), mar=c(3,4.5,1,1))
  plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
  return(list(slopes=x,
              param=list(scal.exp=d, c=c, b=b, f=f, prop.rang=prop.rang, rang=rang, cttail=cttail,
                         dims=dims, aux=aux, aux2=aux2, slataux=slataux), d2=d2, dn=dn, cdims=cdims, d2.minslope=d2.minslope,
              rsq.method=data.frame(d2, slope=round(mm[1],3), pval=round(mm[3],5), d2.minslope=d2.minslope, d2.minslope.se=d2.minslope.se, d2.minslope.p=d2.minslope.p, dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1)),
              dens.method=data.frame(cd.dens.single=aux2[1,1], se.single=aux2[1,2],pval=aux2[1,3], cd.dens.overall=aux2[2,1], se.overall=aux2[2,2], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))))
}
cd.mfm <- function(var, tau="auto", delay.technique="ami", sel.method="first.minimum", extra.m=10, tw="auto", prop.rang.max=0.5, prop.rang.min=0.5, neps=1000, rang=100, eps.min=0.01){ # tau is embedding delay
  # calculate delay (tau) if auto
  if (tau=="auto"){
    tau <- timeLag(var, technique = delay.technique, selection.method=sel.method, lag.max = 100, do.plot = F)
    a <- print(paste("Delay (tau) =",tau))
  }
  a <- print(paste("Delay (tau) =",tau))
  attract(var [1:c(round(0.25*length(var),0))], lag=tau, type="p", main= a) # show attractor
  emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
  if (tw=="auto"){
    #Step 2: Compute Theiler window parameter (tw) required for false nearest
    # neighbours test
    #Step 2a: Autocorrelation function
    lag.max=100
    acf.run<-acf(var,lag.max, plot=F)
    acf.out<-acf.run$acf #array of acf values
    #Step 2b: Use embedding approach to calculate delay at which AMI hits
    #its first minimum.
    acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
    acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
    acf.hold<-matrix(0,acf.adj.length,1)
    for (i in 1:acf.adj.length){ #loop to compute successfive value differences
      acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
      acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
    } #end iloop
    #Step 2c: Estimate Theiler window (tw)
    tw<-sum(acf.hold)
  }
  cdd <- d2(var, m = emb.dim+extra.m, d = tau, t = tw, eps.min = eps.min, neps=neps) # run d2 routine
  return(cd_calc=cd.calc(cdd, dims=1:(emb.dim+extra.m), prop.rang.max = prop.rang.max, prop.rang.min = prop.rang.min, rang = rang))
}
cd.calc.plots <- function(cd.calc.obj){
  x <- cd.calc.obj$slopes
  c <- cd.calc.obj$param$c
  b <- cd.calc.obj$param$b
  f <- cd.calc.obj$param$f
  prop.rang <- cd.calc.obj$param$prop.rang
  rang <- cd.calc.obj$param$rang
  cttail <- cd.calc.obj$param$cttail
  slataux <- cd.calc.obj$param$slataux
  d2.minslope <- cd.calc.obj$d2.minslope
  aux <- cd.calc.obj$param$aux
  aux2 <- cd.calc.obj$param$aux2
  cdims <- cd.calc.obj$cdims
  dims <- cd.calc.obj$param$dims
  dn <- cd.calc.obj$dn
  d2 <- cd.calc.obj$d2
  # graphic output
  par(mfrow=c(5,1), mar=c(3,4.5,1,1))
  plot_b(na.omit(cbind(x[,1],(b+f)*100)), y1 = 60, y2=100, ylab="R-squared x Stability (1-PV)")
  for (i in 2:nrow(cdims)){
    lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ x[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
  }
  points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
  points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
  plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
  plot(d2~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Correlation dimension (D2)", xlab="Embeddng dimension")
  plot(d2.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Corrected D2", xlab="Embeddng dimension")
  # plot line on graph
  lines(rep(d2$d2,length(cttail)) ~ cttail, lwd=4, col="blue")
  lines(rep(dn,length(dims)) ~ c(1:length(dims)), lwd=4, col="black")
  lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

  # Plot density estimation of D2
  plot(aux, pch=21, bg="red", las=1, ylab="Corr. Dimension (D2)", xlab="Embedding dimension")
  lines(rep(aux2$cd[1],5) ~ c((length(dims)-4):length(dims)), col="blue", lwd=2)
  lines(rep(aux2$cd[2],length(1:max(dims))) ~ c(1:max(dims)), col="blue", lwd=2)

  ##print result rsq method
  # cbind(d2,pval=round(mm[3],5), dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1))
  ## print results density estimation of D2
  # cbind(aux2[1,], aux2[2,-3], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))
  par(mfrow=c(1,1), mar=c(3,4.5,1,1))
  plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")

}
summary.cd.calc <- function(cd.calc.obj){
  return(data.frame(cd.calc.obj$rsq.method,
                    cd.calc.obj$dens.method))
}
#Code 7.3 Compute correlation dimension for time series using Takens estimator
cd_takens<-function(x,m_max) {
  cd.m<-matrix(0,m_max,1) #store estimated correlation dimensions
  for(j in 2:m_max) { #iterate over embedding dimensions (m)
    #Step 1: Compute embedding delay and Theiler window
    embed<-embed_udf(x)
    d<-embed[[1]] #embedding delay
    tw<-embed[[3]] #Theiler window
    #Step 2: Compute embedded data matrix
    library(tseriesChaos)
    Mx<-embedd(x,j,d) #embedded data matrices
    n<-nrow(Mx)
    #Step 3: Compute distance matrix
    library(fields)
    dist<-rdist(Mx) #Distance matrix
    dist.vec<-as.vector(dist)
    #Step 4: Adjust distance matrix to Theiler window
    #Step 4a: reduce to relevant rows and columns
    dist.1<-dist[(tw+1):n,1:(n-tw)]
    #Step 4b: reduce to relevant distances in each column
    dist.2<-matrix(0,(n-tw),(n-tw)) #storage matrix for loop
    for(i in 1:(n-tw)) { #iterate over columns of dist.1
      column<-dist.1[,i][i:(n-tw)]
      length(column)<-n-tw #make reduced columns same length for storage
      dist.2[,i]<-column
    } #end loop i
    #Step 5: Put distances in matrix into vector
    dist.vec1<-as.vector(dist.2) #distances not satisfying Theiler window
    #have NAs
    dist.vec2<-na.omit(dist.vec1) #remove NAs, only distances satisfying
    #Theiler window remain
    if(tw==0) {distances<-dist.vec} else {distances<-dist.vec2}
    #Step 6: Set upper threshold on distance
    x.thresh<-0.5*sqrt(sum(x^2)/length(x)) #1/2 root mean squared error (rms)
    distances.thresh<-distances[-c(which(distances>x.thresh))] #omit distances over threshold
    #Step 7: Takens estimation of correlation dimension
    cd<--1/mean(log(distances.thresh/x.thresh))
    cd.m[j,]<-cd #vector storing correlation dimensions over range of
    #embedding dimensions
  } #end loop j
  return(list(cd=cd.m, delay=d, tw=tw))
} #end user-defined function
cd_fertakens<-function(x, m_min=2, m_max="auto", d="ami", tw="auto", sel.meth="first.e.decay") {
  #Step 1: Compute embedding delay (d), max embedding dimension (m_max) and Theiler window
  if(d=="ami"){
    d <- timeLag(x, technique = "ami", selection.method=sel.meth, lag.max = 100, do.plot = F)
  }
  if(d=="acf"){
    d <- timeLag(x, technique = "acf", selection.method=sel.meth, lag.max = 100, do.plot = F)
  }
  # calculate embedding dimension if m_max="auto"
  if (m_max=="auto"){
    m_max <- 10+estimateEmbeddingDim(x, time.lag = d, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
  }
  cd.m<-matrix(0,m_max,1) #store estimated correlation dimensions
  if (tw=="auto"){
    #Step 2: Compute Theiler window parameter (tw) required for false nearest
    # neighbours test
    #Step 2a: Autocorrelation function
    lag.max=100
    acf.run<-acf(x,lag.max, plot=F)
    acf.out<-acf.run$acf #array of acf values
    #Step 2b: Use embedding approach to calculate delay at which AMI hits
    #its first minimum.
    acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
    acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
    acf.hold<-matrix(0,acf.adj.length,1)
    for (i in 1:acf.adj.length){ #loop to compute successfive value differences
      acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
      acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
    } #end iloop
    #Step 2c: Estimate Theiler window (tw)
    tw<-sum(acf.hold)
  }
  #iterate over embedding dimensions (m)
  for(j in m_min:m_max) {
    #Step 2: Compute embedded data matrix
    Mx<-embedd(x,j,d) #embedded data matrices
    n<-nrow(Mx)
    #Step 3: Compute distance matrix
    dist<-rdist(Mx) #Distance matrix
    dist.vec<-as.vector(dist)
    #Step 4: Adjust distance matrix to Theiler window
    #Step 4a: reduce to relevant rows and columns
    dist.1<-dist[(tw+1):n,1:(n-tw)]
    #Step 4b: reduce to relevant distances in each column
    dist.2<-matrix(0,(n-tw),(n-tw)) #storage matrix for loop
    for(i in 1:(n-tw)) { #iterate over columns of dist.1
      column<-dist.1[,i][i:(n-tw)]
      length(column)<-n-tw #make reduced columns same length for storage
      dist.2[,i]<-column
    } #end loop i
    #Step 5: Put distances in matrix into vector
    dist.vec1<-as.vector(dist.2) #distances not satisfying Theiler window
    #have NAs
    dist.vec2<-na.omit(dist.vec1) #remove NAs, only distances satisfying
    #Theiler window remain
    if(tw==0) {distances<-dist.vec} else {distances<-dist.vec2}
    #Step 6: Set upper threshold on distance
    x.thresh<-0.5*sqrt(sum(x^2)/length(x)) #1/2 root mean squared error (rms)
    distances.thresh<-distances[-c(which(distances>x.thresh))] #omit distances over threshold
    #Step 7: Takens estimation of correlation dimension
    cd<--1/mean(log(distances.thresh/x.thresh))
    cd.m[j,]<-cd #vector storing correlation dimensions over range of
    #embedding dimensions
  } #end loop j

  ## minimum slope (5) ##
  cdims <- data.frame(embdim=c(1:length(cd.m)), cd=as.numeric(cd.m))
  slataux <- NA
  plataux <- NA
  for (i in 5:length(cdims$embdim)){
    aaa <- summary.lm(mblm(cd ~ embdim,dataframe = cdims[c((i-4):i),], repeated=T))$coefficients[2,]
    slataux[i] <- abs(as.numeric(aaa[1]))
    plataux[i] <- as.numeric(aaa[4])
  }
  d2.minslope <- mean(cdims$cd[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])
  d2.minslope.se <- sd(cdims$cd[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])/sqrt(5)
  d2.minslope.p <- plataux[which(slataux==min(slataux, na.rm=T))]
  plot(cd~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Correlation dimesion (D2)", xlab="Embeddng dimension")

  # estimate CD
  mm <-summary.lm(mblm(cd ~ embdim, data=tail(cdims,5), repeated=T))$coefficients[2,c(1,2,4)]
  d2 <- data.frame(d2=mean(tail(cdims$cd,5)),d2.se=sd(tail(cdims$cd,5))/sqrt(length(5)), d2.slope= as.numeric(mm[1]), pval=as.numeric(mm[3]))
  # plot line on graph
  lines(rep(d2$d2,5) ~ tail(cdims$embdim,5), lwd=4, col="blue")
  lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

  return(list("cds"=cdims,
              "cd"=data.frame(d2.tail=d2$d2, d2.tail.se=d2$d2.se, d2.tail.slope.pval=d2$pval,
                              d2.minslope=d2.minslope, d2.minslope.se=d2.minslope.se, d2.minslope.p=d2.minslope.p),
              "delay"=d, "tw"=tw))
} #end user-defined function
lorenz_udf<-function(x0,y0,z0,sigma,beta,rho,t.end,delta) {
  #Initial conditions and parameters
  state<-c(x=x0,y=y0,z=z0) #initial conditions
  parameters<-c(sigma,beta,rho) #parameters giving chaotic dynamics
  #ODE model
  model<-function(t,state,parameters){
    with(as.list(c(state,parameters)),{
      dx<- sigma*(y-x) #Lorenz equations
      dy<- x*(rho-z)-y
      dz<- x*y-beta*z
      list(c(dx,dy,dz))
    }) #end with (as.list...
  } #end model function
  #Solution
  times<-seq(0,t.end,by=delta) #integration step
  library(deSolve) #ODE solver package
  out<-ode(y=state,times=times,func=model,parms=parameters,method="lsoda")
  #Solution variables
  x<-out[,"x"];y<-out[,"y"];z<-out[,"z"]
  results<-list(x,y,z)
  return(results)
} #end user-defined function
embed_udf <-function(x){
  #Step 1: Calculate embedding delay
  #Step 1a. Compute average mutual information (AMI) function
  library(tseriesChaos)
  mutual.out<-mutual(x) #mutual(tseriesChaos)
  #Step 1b: Use embedding approach to calculate delay at which AMI hits
  #its first minimum
  mutual.em<-embedd(mutual.out,2,1) #embedd(tseriesChaos)
  mutual.adj.length<-length(mutual.out)-1 #lose 1 observation to delay
  mutual.hold<-matrix(0,mutual.adj.length,1)
  for (i in 1:mutual.adj.length){ #loop to compute successfive value differences
    mutual.test<-if(mutual.em[i,1]>mutual.em[i,2])TRUE else break
    mutual.hold[i,1]<-mutual.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
  } #end iloop
  mutual.hold.sum<-sum(mutual.hold)
  #Step 1c: Estimate embeddeding delay (d). If the mutual information function is
  #decreasing across all 20 delays, set delay at max = 20
  d<-if(mutual.hold.sum<20)mutual.hold.sum else 20 #Embedding delay
  #Step 2: Compute Theiler window parameter (tw) required for false nearest
  # neighbours test
  #Step 2a: Autocorrelation function
  lag.max=100
  acf.run<-acf(x,lag.max)
  acf.out<-acf.run$acf #array of acf values
  #Step 2b: Use embedding approach to calculate delay at which AMI hits
  #its first minimum.
  acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
  acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
  acf.hold<-matrix(0,acf.adj.length,1)
  for (i in 1:acf.adj.length){ #loop to compute successfive value differences
    acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
    acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
  } #end iloop
  #Step 2c: Estimate Theiler window (tw)
  tw<-sum(acf.hold)
  #Step 3: Embedding dimension (m)
  #Step 3a: False nearest neighbours function
  m.max<-6 #maximum number of embedding dimensions to consider
  fn.out<-false.nearest(x,m.max,d,tw) #false.nearest(tseriesChaos)
  fn.out[is.na(fn.out)] <- 0 #set NA in fn.out to zero
  #plot(fn.out)
  #Step 3b: Find delay at which false nearest neighbours decrease below set tolerance
  #Output vector of fnn percentages from fn.out
  fnp<-c(fn.out[1],fn.out[3],fn.out[5],fn.out[7],fn.out[9],fn.out[11])
  fnp.tol<-fnp>0.15 #If fnp greater than tolerance of 15%, T entered into fnp.tol
  fnp.tol.sum<-sum(fnp.tol) #sum up number of T's
  m<-if(fnp.tol.sum<m.max)fnp.tol.sum+1 else m.max #Embedding dimension
  #Step 4: Embed time series (Mx)
  #If m=1, embedd routine crashes due to 'subscript out of bounds' error--need to
  #guarantee an embedding dimension of at least two:
  if(m<=1){m<-2} else {m}
  Mx<-embedd(x,m,d) #embedd(tseriesChaos)
  #Results
  results.embed_udf<-list(d,m,tw,Mx)
  return(results.embed_udf)
} #end user-defined function
season.dates <-function(st.date, nyears){
  yini <- as.numeric(substring(as.character(st.date), c(1), c(4)))
  yys <- rep(yini:(yini+(nyears-1)), each=4)
  mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=nyears)
  mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=nyears)
  res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
  return(res)
}
season.dates.yrs <-function(yys){
  mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=length(yys))
  mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=length(yys))
  yys <- rep(yys, each=4)
  res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
  return(res)
}


date.fun <- function(date.fluxnet){
  return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
}
#### prova ####
# library (deSolve)
# library (tseriesChaos)
# library (fields)
#
# ## functions to perform a logistic map simulaiton
# f.x<- function(x,r){
#   r*x*(1-x)
# }
# f.temp<-function(xinit,nstep,r){ # starting function f.temp
#   xt<- numeric()
#   x<- xinit
#   xt[1]<- x
#   for(i in 2:nstep){
#     y<- f.x(x,r)
#     x<- y
#     xt[i]<- x
#   }
#   # plot(xt,type="b",xlab="time",ylab="x(t)",
#   #      cex.lab=1.7,cex.axis=1.3,lwd=2)
#   return(xt)
#   #xt # comment to skip iterates
# } # ending function f.temp
# ## function to draw the time plot ##
# f.temp.graph<-function(xinit,nstep,r){ # starting function f.temp
#   xt<- numeric()
#   x<- xinit
#   xt[1]<- x
#   for(i in 2:nstep){
#     y<- f.x(x,r)
#     x<- y
#     xt[i]<- x
#   }
#   plot(xt,type="b",xlab="time",ylab="x(t)",
#        cex.lab=1.7,cex.axis=1.3,lwd=2)
#   #xt # comment to skip iterates
# } # ending function f.temp
# ### parameters and initial conditions
# # vary r: r<- 2.8, r<- 3.2, r<- 3.5, r<- 4
# xinit<- 0.01
# nstep<- 10000
# r<- 4
# f.temp.graph(xinit,25,r)
# logistmap.ts <-f.temp(xinit,nstep,r) # call up the time plot
# x <- logistmap.ts
# # Generate Lorenz data with user-defined function 'lorenz_udf'
# lorenz_results<-lorenz_udf(x0=1,y0=1,z0=1,sigma=10,beta=8/3,rho=28,
#                            t.end=100,delta=0.01)
# x <- lorenz_results[[1]]
# # initiating routine
# tau <- timeLag(var, technique = "ami", selection.method="first.e.decay", lag.max = 100, do.plot = T)
# a <- print(paste("Delay (tau) =",tau))
# attract(var [1:4000], lag=tau, type="p", main= a) # show attractor
# emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 30) # calculating embeding dimension #
#
#
#
# # using cd_takens
# x <- logistmap.ts
# attract(x [1:4000], lag=10, type="p", main= a) # show attractor
# emb.dim <- estimateEmbeddingDim(x, time.lag = 10, max.embedding.dim = 30) # calculating embeding dimension #
#
# m_max<-10 #maximum embedding dimension
# cd_m<-cd_takens(x,m_max=m_max)
# cd_m
# a <- Sys.time()ens(x,m_min=2, m_max="auto", d = "ami", sel.meth = "first.e.decay") # sel.meth="first.e.decay" (default) or "first.minimum" (like in cd_takens)
# cd_m2
# Sys.time() - a
# attract(x [1:4000], lag=cd_m$delay, type="l", main= a) # show attractor
# attract(x [1:4000], lag=1, type="p", main= a) # show attractor
#
#
# m<-1:m_max #revised x-axis
# cd.m.plot<-plot(m,cd_m,xaxt="n",xlab="",ylab="correlation dimension",
#                 pch=15,type="b")
# #Custom x-axis, side=1 is x-axis, "at" defines 'tick-mark' numbers
# axis(side=1,at=1:length(cd_m))
# #Label custom x-axis, "line=2.5" puts label below tick-mark numbers
# mtext(side=1,"embedding dimension",line=2,cex=0.8)
# #Label points in plot
# round(cd_m,digits=2)
#
#
#
# ### old stile CD ###
# var <- x
# # initiating routine
# tau <- timeLag(var, technique = "ami", selection.method="first.e.decay", lag.max = 100, do.plot = T)
# a <- print(paste("Delay (tau) =",tau))
# attract(var [1:4000], lag=tau, type="p", main= a) # show attractor
# emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
# a <- Sys.time()
# cd.lor.ami.nf.1 <- d2(var, m = emb.dim+10, d = tau, t = 64, eps.min = 0.1, neps=1000) # run d2 routine
# # id.lor.ami.nf.1 <- infDim(var, min.embedding.dim = emb.dim, max.embedding.dim = emb.dim+20, time.lag= tau,
# #                           min.fixed.mass = 0.01, max.fixed.mass = 1, number.fixed.mass.points = 500,
# #                           radius=mean(abs(var[-1]-var[-length(var)]))*0.95, theiler.window = 200, do.plot=F)
# ml.lor.ami.nf.1 <- maxLyapunov(var, sampling.period=0.005, min.embedding.dim = emb.dim+1, max.embedding.dim = emb.dim + 10,
#                                time.lag = tau, radius=1, max.time.steps=4000, do.plot=FALSE)
#
# Sys.time() - a
#
# # results
# plot_c(cd.lor.ami.nf.1) # Plot correlation integrals over m (for scaling range)
# plot(id.lor.ami.nf.1) # Plot id results
# plot(ml.lor.ami.nf.1,type="l", xlim = c(0,8))
# ml.lor.ami.nf.1.est <- estimate(ml.lor.ami.nf.1, regression.range = c(2,5),
#                                 do.plot = T,type="l"); cat("expected: 0.906  --- estimate: ", ml.lor.ami.nf.1.est,"\n")
# # a <- id.calc(id.lor.ami.nf.1, dims=15:20, w.var = 0.85, correction="loess",add = 0)
# # cbind(a$rsq.method, a$dens.method)
# # locator()
# a <- cd.calc(cd.lor.ami.nf.1, dims=1:(emb.dim+10))
# cbind(a$rsq.method, a$dens.method)
# locator()
# cd.lor.ami.nf.1[,1]
#
#
#
# cd.mfm(x, tau="auto", delay.technique="ami", sel.method="first.e.decay")
# a <- cd_fertakens(x[1:5000])
#

#### prova flux ####
# fi.hyy <- read.table(file="../../fluxnet/FLX_FI-Hyy_FLUXNET2015_SUBSET_HH_1996-2014_1-3.csv", header=T, sep=",")
# head(fi.hyy)
# table(fi.hyy$NEE_VUT_REF_QC)
# # Data quality flags
# # 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
#
# # calculate time
# fi.hyy$year <- NA; fi.hyy$month <- NA; fi.hyy$day<-NA; fi.hyy$hour <- NA; fi.hyy$min <- NA
# for (i in 1:nrow(fi.hyy)){
#   a <-substring(as.character(fi.hyy$TIMESTAMP_END[i]), c(1,5,7,9,11), c(4,6,8,10,12))
#   fi.hyy$year [i] <- as.numeric(a[1])
#   fi.hyy$month [i]<- as.numeric(a[2])
#   fi.hyy$day [i]<- as.numeric(a[3])
#   fi.hyy$hour [i]<- as.numeric(a[4])
#   fi.hyy$min [i]<- as.numeric(a[5])
# }
#
# table(fi.hyy$year[which(fi.hyy$NEE_VUT_REF_QC==3)])
#
#
# subfi.hyy <- subset(fi.hyy, TIMESTAMP_END>200001010000&TIMESTAMP_END<200101010000)
# var <- subfi.hyy$NEE_VUT_REF
# var <- embedd(var, 20, 1)
# var <- (var[,1]+var[,2]+var[,3]+var[,4]+var[,5]+var[,6])/6
#
# head(var)
#
# var <- logistmap.ts
# var <- lorenz_results[[1]]
#
# tau <- timeLag(var, technique = "ami", selection.method="first.minimum", lag.max = 100, do.plot = T)
# a <- print(paste("Delay (tau) =",tau))
# attract(var [1:10000], lag=tau, type="l", main= a) # show attractor
# # pca
# var <- prcomp(embedd(var, 15, 1), scale.=T, center=T)
# summary (var)
# var <- var$x[,c(1:3)]
# attract.or(var, type="l")
#
# library (Rdimtools)
# ## generate three different dataset
# ## compute
# out1 = est.correlation(var, method = "cut")
# plot(log(out1$r), log(out1$Cr), main="swiss roll")
#
# out1 <- numeric()
# for (i in 10:ncol(var)){
# out1 [i] = est.correlation(var[,c(10:i)], method = "cut")$estdim
# }
# plot(out1)
#
#
# ## visually verify : all should have approximate slope of 2.
# opar <- par(no.readonly=TRUE)
# par(mfrow=c(1,3))
# plot(log(out2$r), log(out2$Cr), main="ribbon")
# plot(log(out3$r), log(out3$Cr), main="twinpeaks")
# par(opar)
#
#
# subfi.hyy <- subset(fi.hyy, TIMESTAMP_END>200001010000&TIMESTAMP_END<200201010000)
# subfi.hyy$sel <- c(rep(c(1,2,3), times=nrow(subfi.hyy)/3),c(1,2))
# # aux <-  embedd(subfi.hyy$NEE_VUT_REF, 20, 1)
# # subfi.hyy$var <- c(rep(NA,19),c(aux[,1]+aux[,2]+aux[,3]+aux[,4]+aux[,5]+aux[,6])/6) # 3 hour average
# subfi.hyy <- subfi.hyy[which(subfi.hyy$sel==1),]
# var <- subfi.hyy$NEE_VUT_REF
# var <- subfi.hyy$P_F
# # var <- embedd(var, 20, 1)
# # var <- (var[,1]+var[,2]+var[,3]+var[,4]+var[,5]+var[,6])/6 # 3 hour average
# summary(var)
# attract(var, lag=6, type="l")
# # increasing eps.min increases chance of ups and downs in local scaling exponents
# # if too low you may have to reduce the proportion of the range (slopes separate more)
# tt <- Sys.time()
# a1 <- cd.mfm(var, tau="auto", delay.technique="ami", sel.method="first.minimum", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
# # a2 <- cd.mfm(var, tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
# # cd.mfm(var[(4320*8):(4320*9)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
# Sys.time() - tt
#
# a <- cd_fertakens(var, sel.meth = "first.e.decay")
# a
# b <- cd_fertakens(var, sel.meth = "first.minimum")
# b

#### Starts analyses ####
#### Importing HH data all sites ####
# setwd("~/dades/chaos/fluxchaos")
# load("~/dades/biodiver_flux/sbioflux.Rdata")
# unique(sbioflux$site)
# # data-list for all 62 sites
# site.list <- list()
# file_names <- dir("~/dades/fluxnet/", pattern="_HH_.*\\.csv$") # where you have your files
# file_split <- strsplit(file_names, split = "_")
# a <- character() # name plot
# for (i in 1:length(file_split)){
#   a [i] <- file_split[[i]][2]
# }
# b <- character() # years measurements
# for (i in 1:length(file_split)){
#   b [i] <- as.numeric(strsplit(file_split[[i]][6], split="-")[[1]])[2] - as.numeric(strsplit(file_split[[i]][6], split="-")[[1]])[1]
# }
# a <- data.frame("name"=a,"nyears"=as.numeric(b))
#
# files <- lapply(paste("~/dades/fluxnet/", file_names[which(a$name%in%unique(sbioflux$site))], sep=""), read.delim, sep = ",")
# names(files) <- a$name[which(a$name%in%unique(sbioflux$site))]
#
# save(files, file="./fluxchaos.Rdata") # 13/05/2020
#
load("./fluxchaos.Rdata")
#### CDs: Site, Annual and Seasonal - AU-DaP site #1 ####
## AU-DaP
data <- files[[1]]
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Cut start and end bits with low data quality for flux = 3
# first year and probably the last
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
data$TIMESTAMP_START[c(1,nrow(data))]
data <- subset(data, TIMESTAMP_START>=200801010000) # remove first year
data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.30)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.25, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.30)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.30)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.20)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)

### Multi-year calculation ##
neps <- 500
0.8*mean(abs(data$WS_F[-nrow(data)]-data$WS_F[-1]), na.rm=T)
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.25,0.20,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[1])
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site


### Annual calculation ###
neps <- 500
0.8*mean(abs(data$WS_F[-nrow(data)]-data$WS_F[-1]), na.rm=T)
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- 200801010000 + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.02), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[7], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]) # rang=20% works well
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[1]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaP"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
res$date.ini <- as.numeric(paste(rep(c(2008:2012), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(2008:2012), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
season.dates <-function(st.date, nyears){
  yini <- as.numeric(substring(as.character(st.date), c(1), c(4)))
  yys <- rep(yini:(yini+(nyears-1)), each=4)
  mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=nyears)
  mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=nyears)
  res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
  return(res)
}
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.02), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.07), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[6]), silent = T) # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# prec, season 6 fails continuously
# Check results
cd.list.season[[1]]$re # season 1, nee, etc...
cd.calc.plots(cd.list.season[[1]]$vpd)

# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaP"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
# cd.results$site  <- rbind(cd.results$site, data.site)
# cd.results$year <- rbind(cd.results$year, data.year)
# cd.results$season <- rbind(cd.results$season, data.season)
# cd.results <- list(site= data.site, year=data.year, season=data.season)
# save(cd.results, file="./cd_results.Rdata") # first save 17/05/2020
#
# cd.files <- list("AU-DaP"=list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season))
# save(cd.files, file="./cd_files.Rdata") # first save 17/05/2020

#### CDs: Site, Annual and Seasonal - AU-DaS site #2 ####
## AU-DaS
site.num <- 2
names(files)[site.num]
data <- files[[site.num]]
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Does not need removing years!
# Cut start and end bits with low data quality for flux = 3
# first year and probably the last
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# data$TIMESTAMP_START[c(1,nrow(data))]
# data <- subset(data, TIMESTAMP_START>=200801010000) # remove first year
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.30)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.30)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.30)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.30)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.25,0.25,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaS"
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- data$TIMESTAMP_START [1] + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[7], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]) # rang=20% works well
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a

cd.list.yr[[5]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaS"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
res$date.ini <- as.numeric(paste(rep(c(2008:(2008+nyears-1)), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(2008:(2008+nyears-1)), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==25){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=25, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

#### CDs: Site, Annual and Seasonal - AU-How site #3 ####
## AU-DaS
site.num <- 3
names(files)[site.num]
data <- files[[site.num]]
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# Cut start and end bits with low data quality for flux = 3
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
data$TIMESTAMP_START[c(1,nrow(data))]
data <- subset(data, TIMESTAMP_START>=200201010000) # remove first year
# remove 2006? no
# data$TIMESTAMP_START[85000]
# a <- data$NEE_VUT_REF_QC
# a[which(data$TIMESTAMP_START<=200601010000|data$TIMESTAMP_START>=200701010000)] <- 0
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# lines(a, type="l", col="red") # fluxes
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year, no
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.25,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- data$TIMESTAMP_START [1] + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[5]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- as.numeric(substring(as.character(data$TIMESTAMP_START[1]), c(1), c(4)))
res$date.ini <- as.numeric(paste(rep(c(year.ini:(year.ini+nyears-1)), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(year.ini:(year.ini+nyears-1)), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==25){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=25, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

#### CDs: Site, Annual and Seasonal - BE-Bra site #4 ####
## BE-Bra
site.num <- 4
names(files)[site.num]
data <- files[[site.num]]
## Add dates
date.fun <- function(date.fluxnet){
  return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
}
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# Cut start and end bits with low data quality for flux = 3
# first year and one of the middle ones
table(data$NEE_VUT_REF_QC, data$year)
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
data$TIMESTAMP_START[c(1,nrow(data))]
data <- subset(data, NEE_VUT_REF_QC>(-9999)) # remove missing data
data <- subset(data, year>=1999) # remove first year
table(data$year) # good, all days all years
# remove 2006? no
# data$TIMESTAMP_START[85000]
# a <- data$NEE_VUT_REF_QC
# a[which(data$TIMESTAMP_START<=200601010000|data$TIMESTAMP_START>=200701010000)] <- 0
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# lines(a, type="l", col="red") # fluxes
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year, no
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.20)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for VPD_F, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method


# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[13]]$vpd # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==24){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - BE-Vie site #5 ####
## BE-Vie
site.num <- 5
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- subset(data, year>1996) # remove missing data
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for VPD_F, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method


# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  if (i == 11){yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4])} else {
    yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4])} # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[1]]$vpd # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[11]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==33|i==72){cd.re <- cd.nee
    cd.re$rsq.method [,] <- 0
    cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Gro site #6 ####
## BE-Vie
site.num <- 6
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- subset(data, year>2003) # remove low quality years
data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.18)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.18,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[1]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Man site #7 ####
## BE-Vie
site.num <- 7
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1994,2004,2005,2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.3,0.2,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[4]]$re)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if (i == 39){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Oas site #8 ####
## CA-Oas
site.num <- 8
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.2)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.2,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[12]]$re)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i == 23){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if (i == 7){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) } else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if (i==7){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) } else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Qfo site #9 ####
## CA-Oas
site.num <- 9
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2003)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.4)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.4,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i==7){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.18), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP1 site #10 ####
## CA-TP1
site.num <- 10
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002,2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.2)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.2,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if(i==39){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(i==39){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[2]]$re # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[1]]$re)
# extract results (starting in two - season 1 failed)
for (i in 2:seasons){
  if(i==2){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i-1] <- rownames(res.gpp)[i-1] <- rownames(res.re)[i-1] <- rownames(res.temp)[i-1] <- rownames(res.ws)[i-1] <- rownames(res.prec)[i-1] <- rownames(res.vpd)[i-1] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=(seasons-1))
res$date.ini <- rep(sea.dat$date.ini[-1], times=7)
res$date.end <- rep(sea.dat$date.end[-1], times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP3 site #11 ####
## CA-TP3
site.num <- 11
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002, 2006, 2007)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i == 23|i==27|i==31){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i == 27|i==28|i==34|i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if (i == 38){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP4 site #12 ####
## CA-TP4
site.num <- 12
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.4)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.4,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==3|i==4){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- 0
    yr.cd.re$dens.method [,] <- 0} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.2), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Cha site #13 ####
## CH-Cha
site.num <- 13
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005, 2009)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.4)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.4,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Dav site #14 ####
## CH-Dav
site.num <- 14
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.35)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.35,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i==65){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Fru site #15 ####
## CH-Fru
site.num <- 15
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005,2006, 2009)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if(i == 19){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Lae site #16 ####
## CH-Lae
site.num <- 16
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2004)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i==3){my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CZ-BK1 site #17 ####
## CZ-BK1
site.num <- 17
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2004)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==6|i==9|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(i==8|i==12|i==16|i==24|i==25|i==32){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=40, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CZ-wet site #18 ####
## CZ-wet
site.num <- 18
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.25,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Gri site #19 ####
## DE-Gri
site.num <- 19
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.20)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.25,0.2,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Hai site #20 ####
## DE-Hai
site.num <- 20
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau=15, delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i == 3){ my.cd <- cd.mfm(data[,vars[i]], tau=15, delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Lnf site #21 ####
## DE-Lnf
site.num <- 21
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2002)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i == 3){ my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Tha site #22 ####
## DE-Tha
site.num <- 22
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if (i == 3) {my.cd <- cd.mfm(data[,vars[i]], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) } else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

 eladio e gordo
data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DK-Sor site #23 ####
## DK-Sor
site.num <- 23
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996,2014)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.10), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - ES-LJu site #24 ####
## ES-LJu
site.num <- 24
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2004,2005)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if (i ==7){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==16){cd.re <- cd.nee
    cd.re$rsq.method [,] <- 0
    cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
    cd.vpd$rsq.method [,] <- 0
    cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FI-Hyy site #25 ####
## FI-Hyy
site.num <- 25
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i == 72| i==44){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) } else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FI-Sod site #26 ####
## FI-Sod
site.num <- 26
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears


# draw attractors for figures (check embedding dimension in test code below) #
# GPP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$GPP_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=24, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=24, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=24, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=24, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# NEP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$NEE_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=14, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=14, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=14, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=14, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# Re
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$RECO_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.35)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.35, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if(i==15|i==51|i==55){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(i==45){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else { # rang=20% works well
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-Fon site #27 ####
## FR-Fon
site.num <- 27
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2005,2014)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==3){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) } else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-LBr site #28 ####
## FR-LBr
site.num <- 28
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996,1998,1999,2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# draw attractors for figures (check embedding dimension in test code below) #
# GPP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$GPP_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=13, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=13, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=13, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=13, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# NEP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$NEE_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=13, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=13, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=13, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=13, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# Re
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$RECO_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)



# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$NEE_VUT_REF[1:(48*365)], lag=13, type = "p")
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.25, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  # if(i==3){yr.cd.nee <- g
  # yr.cd.gpp <- g
  # yr.cd.re <- g
  # yr.cd.temp <- g
  # yr.cd.ws <- g
  # yr.cd.prec <- g
  # yr.cd.vpd <- g
  #
  # yr.cd.nee$rsq.method [,] <- NA
  # yr.cd.nee$dens.method [,] <- NA
  #
  # yr.cd.gpp$rsq.method [,] <- NA
  # yr.cd.gpp$dens.method [,] <- NA
  #
  # yr.cd.re$rsq.method [,] <- NA
  # yr.cd.re$dens.method [,] <- NA
  #
  # yr.cd.temp$rsq.method [,] <- NA
  # yr.cd.temp$dens.method [,] <- NA
  #
  # yr.cd.ws$rsq.method [,] <- NA
  # yr.cd.ws$dens.method [,] <- NA
  #
  # yr.cd.prec$rsq.method [,] <- NA
  # yr.cd.prec$dens.method [,] <- NA
  #
  # yr.cd.vpd$rsq.method [,] <- NA
  # yr.cd.vpd$dens.method [,] <- NA
  # } else {

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-Pue site #29 ####
## FR-Pue
site.num <- 29
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Col site #30 ####
## IT-Col
site.num <- 30
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996, 1999,2002,2003,2004,2006)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Cpz site #31 ####
## IT-Cpz
site.num <- 31
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Lav site #32 ####
## IT-Lav
site.num <- 32
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    if (i==2|i==5|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
      yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-MBo site #33 ####
## IT-MBo
site.num <- 33
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==32){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Noe site #34 ####
## IT-Noe
site.num <- 34
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2004,2011)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ren site #35 ####
## IT-Ren
site.num <- 35
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1998,2000,2001,2004)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ro1 site #36 ####
## IT-Ro1
site.num <- 36
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2000,2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ro2 site #37 ####
## IT-Ro2
site.num <- 37
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-SRo site #38 ####
## IT-SRo
site.num <- 38
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if (i==12){yr.cd.gpp <- yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Tor site #39 ####
## IT-Tor
site.num <- 39
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - NL-Hor site #40 ####
## NL-Hor
site.num <- 40
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2006,2011)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==2){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      if (i==19){cd.re <- cd.nee
        cd.re$rsq.method [,] <- NA
        cd.re$dens.method [,] <- NA} else {
        cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}}} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - NL-Loo site #41 ####
## NL-Loo
site.num <- 41
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - RU-Fyo site #42 ####
## RU-Fyo
site.num <- 42
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1998)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears


# draw attractors for figures (check embedding dimension in test code below) #
# temp
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$TA_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=28, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=28, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=28, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=28, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# prec
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$P_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=10, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=10, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=10, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=10, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# vpd
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$VPD_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# ws
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$WS_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=35, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=35, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=35, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=35, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)



# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Blo site #43 ####
## US-Blo
site.num <- 43
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1997,1998,1999,2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==27){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Los site #44 ####
## US-Los
site.num <- 44
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000,2007,2008,2009,2010,2011,2012,2013)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if (i==1){cd.gpp <- cd.nee
      cd.gpp$rsq.method [,] <- NA
      cd.gpp$dens.method [,] <- NA} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==27){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Me3 site #45 ####
## US-Me3
site.num <- 45
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==6){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-NR1 site #46 ####
## US-NR1
site.num <- 46
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1998,1999)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i==3){my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else{
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    if(i==7|i==8|i==10|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
      yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Oho site #47 ####
## US-Oho
site.num <- 47
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(1998,1999)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRC site #48 ####
## US-SRC
site.num <- 48
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008,2013,2014)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.15)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRG site #49 ####
## US-SRG
site.num <- 49
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRM site #50 ####
## US-SRM
site.num <- 50
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# draw attractors for figures (check embedding dimension in test code below) #
# temp
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$TA_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=29, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=29, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=29, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=29, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# prec
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$P_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=6, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=6, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=6, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=6, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# vpd
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$VPD_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=29, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=29, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=29, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=29, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# ws
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$WS_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=21, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=21, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=21, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=21, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==38){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Syv site #51 ####
## US-Syv
site.num <- 51
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2001,2007,2008,2009,2010,2011,2012)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  } # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Ton site #52 ####
## US-Ton
site.num <- 52
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2001)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==23|i==35){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- NA
      cd.prec$dens.method [,] <- NA} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Var site #53 ####
## US-Var
site.num <- 53
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==39|i==31){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- NA
      cd.prec$dens.method [,] <- NA} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-WCr site #54 ####
## US-WCr
site.num <- 54
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2007,2008,2009,2010)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  }
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Whs site #55 ####
## US-Whs
site.num <- 55
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if(i==14){cd.gpp <- cd.nee
      cd.gpp$rsq.method [,] <- NA
      cd.gpp$dens.method [,] <- NA} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
    }}
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  }
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Wkg site #56 ####
## US-Wkg
site.num <- 56
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2004)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if(i==6){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
    }}
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else{
    if(i==4|i==26|i==34){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - ZA-Kru site #57 ####
## ZA-Kru
site.num <- 57
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000,2006,2013)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
a <- cd.calc(cd.list$WS_F$param$scal.exp, rang=0.35*neps)
cd.list$WS_F$rsq.method  <- a$rsq.method[1,]
cd.list$WS_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.25,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = (neps*rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA}  else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if (i==22){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)
    }}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if(i==27|i==30|i==31|i==35){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### Cleaning results D2 ####
load(file="./cd_results.Rdata") #
### Code results: ###
# d2: last 5 embedding dimensions method max R2 - min PV
# d2.minslope: 5 embedding dimensions with minimum slope using method max R2 - min PV
# dens.d2: most frequent D2 across dimensions, method max R2 - min PV
# cd.dens.single: most frequent slope using kernel density estiamtions per embedding dimenison
# cd.dens.overall: most frequent slope using kernel density estimation across embedding dimensions
### ### ### ### ### ###

# visual check
boxplot(d2~var, data=cd.results$site)
boxplot(d2.minslope~var, data=cd.results$site)
boxplot(dens.d2~var, data=cd.results$site)
boxplot(cd.dens.single~var, data=cd.results$site)
boxplot(cd.dens.overall~var, data=cd.results$site) # completely different

# Correlation is very good (overall series)
plot(d2~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$d2.minslope)

plot(d2~dens.d2, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$dens.d2)

plot(dens.d2~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$dens.d2,cd.results$site$d2.minslope)

# check with density
plot(d2~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$cd.dens.single)

plot(dens.d2~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$dens.d2,cd.results$site$cd.dens.single)

plot(d2.minslope~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$d2.minslope,cd.results$site$cd.dens.single)

## SITE - Compute minium difference D2 (max R2 - min PV) ##
mnd2 <- function(a,b,c, ase, bse, cse){
  if (any(is.na(c(a, b, c)))){return(list(res=NA,d2=NA, d2se=NA))} else {
    ab <- abs(a-b)
    ac <- abs(a-c)
    bc <- abs(b-c)
    rs <- data.frame(comp=c("ab", "ac", "bc"), dif=c(ab, ac, bc), d2=round(c(mean(c(a,b)),mean(c(a,c)), mean(c(b,c))),digit=2),
                     d2se=c(sqrt(ase^2+bse^2),sqrt(ase^2+cse^2), sqrt(bse^2+cse^2)))
    return(list(res=rs, d2=rs$d2[which(rs$dif==min(rs$dif,na.rm=T))], d2se= rs$d2se[which(rs$dif==min(rs$dif,na.rm=T))]))}
}
# mnd2(4,6,5.5, 0.2, 0.3, 0.1) # works ok!
# mnd2(NA,6,5.5, NA, 0.3, 0.1) # works ok!
cd.results$site$d2.c <- NA
cd.results$site$d2.cse <- NA
for (i in 1:nrow(cd.results$site)){
  a <- mnd2(cd.results$site$d2[i], cd.results$site$d2.minslope[i], cd.results$site$dens.d2[i],
            cd.results$site$d2.se[i], cd.results$site$d2.minslope.se[i], cd.results$site$dens.d2[i]*((cd.results$site$pv[i])/100))
  cd.results$site$d2.c [i] <- a$d2
  cd.results$site$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$site)
plot(d2.c~d2, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$d2)
plot(d2.c~dens.d2, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$d2.minslope)



## YEAR - Compute minium difference D2 (max R2 - min PV) ##
for (i in 1:nrow(cd.results$year)){
  a <- mnd2(cd.results$year$d2[i], cd.results$year$d2.minslope[i], cd.results$year$dens.d2[i],
            cd.results$year$d2.se[i], cd.results$year$d2.minslope.se[i], cd.results$year$dens.d2[i]*((cd.results$year$pv[i])/100))
  cd.results$year$d2.c [i] <- a$d2
  cd.results$year$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$year)
plot(d2.c~d2, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$d2)
plot(d2.c~dens.d2, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$d2.minslope)


## season - Compute minium difference D2 (max R2 - min PV) ##
for (i in 1:nrow(cd.results$season)){
  a <- mnd2(cd.results$season$d2[i], cd.results$season$d2.minslope[i], cd.results$season$dens.d2[i],
            cd.results$season$d2.se[i], cd.results$season$d2.minslope.se[i], cd.results$season$dens.d2[i]*((cd.results$season$pv[i])/100))
  cd.results$season$d2.c [i] <- a$d2
  cd.results$season$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$season)
plot(d2.c~d2, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$d2)
plot(d2.c~dens.d2, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$d2.minslope)


## check and save ##
summary(cd.results$site)
summary(cd.results$year)
summary(cd.results$season)
save(cd.results, file="./cd_results.Rdata") # checked and saved corrected results 25/06/2020


#### TRENDS IN FLUX QUALITY ####
library (mblm)
yfun <- function(var){
  return(substr(var, 1, 4))
}
res.datqual <- data.frame(site.name=names(files), nee.q=NA, nee.q.pval=NA, temp.q=NA, temp.q.pval=NA)
job::job({for (i in 1:length(names(files))){
  data <- files[[i]]
  for (y in 1:nrow(data)){
    data$year[y] <- yfun(data$TIMESTAMP_START[y])
  }
  aux <- aggregate(data[,c("NEE_VUT_REF_QC","TA_F_QC")], by=list("year"=data$year), mean)
  aux$year <- as.numeric(aux$year)
  modnee <- mblm(NEE_VUT_REF_QC ~ year, data=aux)
  res.datqual$nee.q [i] <- modnee$coefficients[2]
  res.datqual$nee.q.pval [i] <- summary(modnee)$coefficients[2,4]
  modtemp <- mblm(TA_F_QC ~ year, data=aux)
  res.datqual$temp.q [i] <- modtemp$coefficients[2]
  res.datqual$temp.q.pval [i] <- summary(modtemp)$coefficients[2,4]
}})
save(res.datqual, file="./trends.datqual.Rdata")
median(res.datqual$nee.q)
hist(res.datqual$nee.q)

# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD




#### Graphs for fwllowshps ####
library (deSolve)
library (tseriesChaos)
library (fields)

par(mfrow=c(3,3))
# Graph 1 - sine wave
t=seq(0,50,0.1)
xy=sin(t)
plot(t,xy,type="l", xlab=NA, ylab="x(t)", las=1, lwd=2, col="blue")
# Graph 2 - Lorenz attractor
lorenz_results<-lorenz_udf(x0=#### Load packages ####
                             setwd("~/dades/chaos/fluxchaos")
                           library (nonlinearTseries)
                           library (tseriesChaos)
                           library (plot3D)
                           library (deSolve) #ODE solver package
                           library (mblm)
                           library (fields)
                           library (doParallel)
                           library (snow)
                           #### Load functions ####
                           date.fun <- function(date.fluxnet){
                             return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
                           }
                           embed_udf <-function(x, mmax=6, d=NA){
                             if(is.na(d)){
                               #Step 1: Calculate embedding delay
                               #Step 1a. Compute average mutual information (AMI) function
                               mutual.out<-mutual(x, lag.max=100, plot=F) #mutual(tseriesChaos)
                               #Step 1b: Use embedding approach to calculate delay at which AMI hits
                               #its first minimum
                               mutual.em<-embedd(mutual.out,2,1) #embedd(tseriesChaos)
                               mutual.adj.length<-length(mutual.out)-1 #lose 1 observation to delay
                               mutual.hold<-matrix(0,mutual.adj.length,1)
                               for (i in 1:mutual.adj.length){ #loop to compute successfive value differences
                                 mutual.test<-if(mutual.em[i,1]>mutual.em[i,2])TRUE else break
                                 mutual.hold[i,1]<-mutual.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                               } #end iloop
                               mutual.hold.sum<-sum(mutual.hold)
                               #Step 1c: Estimate embeddeding delay (d). If the mutual information function is
                               #decreasing across all 100 delays, set delay at max = 100
                               d<-if(mutual.hold.sum<100)mutual.hold.sum else 100 #Embedding delay
                             }
                             #Step 2: Compute Theiler window parameter (tw) required for false nearest
                             # neighbours test
                             #Step 2a: Autocorrelation function
                             lag.max=100
                             acf.run<-acf(x,lag.max, plot=F)
                             acf.out<-acf.run$acf #array of acf values
                             #Step 2b: Use embedding approach to calculate delay at which AMI hits
                             #its first minimum.
                             acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
                             acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
                             acf.hold<-matrix(0,acf.adj.length,1)
                             for (i in 1:acf.adj.length){ #loop to compute successfive value differences
                               acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
                               acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                             } #end iloop
                             #Step 2c: Estimate Theiler window (tw)
                             tw<-sum(acf.hold)
                             #Step 3: Embedding dimension (m)
                             #Step 3a: False nearest neighbours function
                             m.max<-mmax #maximum number of embedding dimensions to consider
                             fn.out<-false.nearest(x,m.max,d,tw) #false.nearest(tseriesChaos)
                             fn.out[is.na(fn.out)] <- 0 #set NA in fn.out to zero
                             #plot(fn.out)
                             #Step 3b: Find delay at which false nearest neighbours decrease below set tolerance
                             #Output vector of fnn percentages from fn.out
                             fnp<-c(fn.out[1],fn.out[3],fn.out[5],fn.out[7],fn.out[9],fn.out[11])
                             fnp.tol<-fnp>0.15 #If fnp greater than tolerance of 15%, T entered into fnp.tol
                             fnp.tol.sum<-sum(fnp.tol) #sum up number of T's
                             m<-if(fnp.tol.sum<m.max)fnp.tol.sum+1 else m.max #Embedding dimension
                             #Step 4: Embed time series (Mx)
                             #If m=1, embedd routine crashes due to 'subscript out of bounds' error--need to
                             #guarantee an embedding dimension of at least two:
                             if(m<=1){m<-2} else {m}
                             Mx<-embedd(x,m,d) #embedd(tseriesChaos)
                             #Results
                             results.embed_udf<-list(d,m,tw,Mx)
                             return(results.embed_udf)
                           } # modified from NLTS analysis book
                           attract2d <- function(var, lag, type="p", cex=0.5, col="red", burn=0){
                             if(burn!=0){
                               aux <- embedd(var[-c(1:burn)],3,lag)} else {aux <- embedd(var,3,lag)}
                             plot(x=aux[,1],y=aux[,2], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", cex.symbols=cex)
                           }
                           attract <- function(var, lag, type="p", bty="b2", ..., phi = 10, theta = 20, add=F, pch=NULL, lwd=NULL, cex=0.5, col="red", alpha=1, burn=0, xlim=NULL, ylim=NULL, zlim=NULL){
                             if(burn!=0){
                               aux <- embedd(var[-c(1:burn)],3,lag)} else {aux <- embedd(var,3,lag)}
                             # scatterplot3d(x=aux[,1],y=aux[,2],z=aux[,3], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), cex.symbols=cex, xlim=xlim, ylim=ylim, zlim=zlim)
                             scatter3D(x=aux[,1],y=aux[,2],z=aux[,3], ..., add=add, alpha = alpha, ticktype = "detailed", type=type, bty= bty, lwd=lwd, cex=cex, pch=pch, phi = phi, theta = theta, col = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), xlim=xlim, ylim=ylim, zlim=zlim)
                           }
                           attract.or <- function(var, type="p", bty="b2", ..., phi = 10, theta = 20, add=F, pch=NULL, lwd=NULL, cex=0.5, col="red", alpha=1, burn=0, xlim=NULL, ylim=NULL, zlim=NULL){
                             if(burn!=0){
                               var <- var[-c(1:burn), ]}
                             # scatterplot3d(x=aux[,1],y=aux[,2],z=aux[,3], type=type, color = col, ylab=paste("Var at lag", lag), xlab="Var", zlab=paste("Var at lag", 2*lag), cex.symbols=cex, xlim=xlim, ylim=ylim, zlim=zlim)
                             scatter3D(x=var[,1],y=var[,2],z=var[,3], ..., add=add, alpha = alpha, ticktype = "detailed", type=type, bty= bty, lwd=lwd, cex=cex, pch=pch, phi = phi, theta = theta, col = col, ylab=paste("PC2"), xlab="PC1", zlab=paste("PC3"), xlim=xlim, ylim=ylim, zlim=zlim)
                           }

                           lorenz_udf<-function(x0,y0,z0,sigma,beta,rho,t.end,delta) {
                             #Initial conditions and parameters
                             state<-c(x=x0,y=y0,z=z0) #initial conditions
                             parameters<-c(sigma,beta,rho) #parameters giving chaotic dynamics
                             #ODE model
                             model<-function(t,state,parameters){
                               with(as.list(c(state,parameters)),{
                                 dx<- sigma*(y-x) #Lorenz equations
                                 dy<- x*(rho-z)-y
                                 dz<- x*y-beta*z
                                 list(c(dx,dy,dz))
                               }) #end with (as.list...
                             } #end model function
                             #Solution
                             times<-seq(0,t.end,by=delta) #integration step
                             out<-ode(y=state,times=times,func=model,parms=parameters,method="lsoda")
                             #Solution variables
                             x<-out[,"x"];y<-out[,"y"];z<-out[,"z"]
                             results<-list(x,y,z)
                             return(results)
                           } #end user-defined function
                           plot_c <- function(M,y1= 0.00000001,y2 = 1, xlim=NULL, ylab=NULL, xlab=NULL, main=NULL ){

                             plot(M[,1],M[,2],log="xy",ylim=c(y1,y2),type="l", xlim=xlim, ylab=ylab, xlab=xlab, main=main, las=1)
                             for(i in c(2:ncol(M))) lines(M[,1],M[,i])

                           }
                           plot_b <- function(M,y1= 0.00000001,y2 = 1, xlim=NULL, ylab=NULL, xlab=NULL, main=NULL ){

                             plot(M[,1],M[,2],ylim=c(y1,y2),type="l", xlim=xlim, ylab=ylab, xlab=xlab, main=main, las=1)
                             for(i in c(2:ncol(M))) lines(M[,1],M[,i])

                           }

                           ## Information dimension function ##
                           pv.fun1 <- function(var1){
                             var <- na.omit(var)
                             if(var1[1]==var1[2]){return(0)}else{
                               return((1-(min(var1[1],var1[2])/max(var1[1],var1[2]))))}
                           }
                           pv.fun <- function(var){
                             var <- na.omit(var)
                             if(length(var)<2){return(NA)} else {
                               return(mean(as.numeric(combn(var, 2, FUN = pv.fun1, simplify = F))))}}
                           id.calc <- function(d, add=0, rang=20, prop.rang.max=1, prop.rang.min=1,
                                               ttail=5, cut=0.99, cut.low=0.01, w.var=0.5, dims=NA, correction="loess"){
                             # initialise
                             # add <- 1
                             # rang <- 20
                             # prop.rang.max <- 1
                             # prop.rang.min <- 1
                             # ttail <- 5
                             # cut <- 0.99 # cut values of density higher than...
                             # cut.low <- 0.01 # cut values of density lower than...
                             # w.var <- 0.35 # weigh of variability vs. Rsq, 0.5 is equal contribution
                             # dims <- 1:30
                             # set up M matrix for analysis
                             # plot_c(M,y1 = 1e-02, y2=14)
                             # plot_c(cbind(M[,1],1/exp(M[,-c(1:6)])), y1 = 0.0000001, y2=1)
                             # plot_c(M[,-c(2:6)], y1=8, y2=15, xlim=c(0.05,1))
                             temp <- t(as.matrix(d$log.radius))
                             if(!is.numeric(dims[1])){dims <- 1:(ncol(temp)-1)}
                             p <- as.numeric(row.names(temp))
                             M <- matrix(nrow=length(temp[,1]),ncol=length(temp[1,])+2)
                             M[,1] <- p;M[,2] <- 0
                             for(j in c(3:length(M[1,]))) M[,j] <- 10^(temp[,j-2])
                             # plot_c(cbind(M[,1],1/M[,2:ncol(M)]), y1 = 0.1, y2=10)
                             # calculate p at which variability betwen dimensions is lower #
                             M <- M[,c(1,(dims+1))]
                             M <- subset(M, (M[,1]<cut)&(M[,1]>cut.low))
                             # var.row <- 1-apply(M[,-c(1:3)], MARGIN = 1, FUN=pv.fun)
                             # var.row <- var.row/max(var.row,na.rm=T)
                             # plot(var.row)
                             ### starts running
                             rang <- round(rang,digit=0)
                             ttail <- round(ttail, digit=0)
                             prop.rang <- seq(prop.rang.max, prop.rang.min, length=(ncol(M)-1))
                             sel <- list()
                             cdims <- data.frame(embdim=c(1:(ncol(M)-1)),id=rep(NA,times=(ncol(M)-1)), eps=NA, rsq=NA, locus=NA)
                             b <- matrix(ncol=(ncol(M)-1), nrow=nrow(M))
                             c <- b # check correlations
                             bbb <- b # matrix for slopes
                             ccc <- b
                             M[M==0] <- NA
                             for (i in 1:(ncol(M)-1)){
                               for (j in (rang+1):(nrow(M)-rang)){
                                 if (length(which(is.na(M[(j-rang):(j+rang),(i+1)])))>=(rang/2)){b [j,i] <- NA} else {
                                   # b [j,i] = summary(lm(log(M[(j-rang):(j+rang),(i+1)])~ log(M[(j-rang):(j+rang),1])))$r.squared # to use local Rsq
                                   bbb [j,i] = 1-summary(lm(log(M[(j-rang):(j+rang),(i+1)])~ log(M[(j-rang):(j+rang),1])))$coefficients[2,1]
                                   b [j,i] <- bbb [j,i]} # to use local slope
                               }
                             }

                             # calculate variability between rows (1-pv= stability)
                             var.row <- 1-apply(b[,-c(1:3)], MARGIN = 1, FUN=pv.fun) # estimate stability (1-PV)
                             var.row [is.infinite(var.row)] <- NA
                             var.row <- as.numeric((scale(var.row)+(abs(min(scale(var.row), na.rm=T))+1))/max(scale(var.row)+(abs(min(scale(var.row), na.rm=T))+1),na.rm=T))

                             for (i in 1:(ncol(M)-1)){
                               c [,i] <- b[,i]
                               ccc [,i] <- bbb[,i]
                               # b [,i] <- b[,i]*(1-w.var) * (var.row*w.var) # multiplicative weighting
                               b [,i] <- b[,i]*(1-w.var) + (var.row*w.var) # additive weighting
                               if (length(which(!is.na(b[,i])))<5){} else {
                                 cdims$rsq [i] <- max(b[,i],na.rm=T) # maximum rsq
                                 cdims$locus[i]<- (which(b[,i]==cdims$rsq[i])) # place max rsq
                                 cdims$eps [i] <- M[cdims$locus[i],1] # epsilon of max rsq
                                 sel[[i]] <- c((cdims$locus[i]-(round(rang*prop.rang[i],0))):(cdims$locus[i]+(round(rang*prop.rang[i],0))))
                                 cdims$id [i] <- 1/as.numeric(lm(log(M[sel[[i]],(i+1)]) ~ log(M[sel[[i]],1]))$coef[2])
                               }
                             }


                             ## correcting selection ##
                             sel.c <- list()
                             if(correction=="none"){cdims$locus.c <- cdims$locus} # no correction
                             if(correction=="loess"){cdims$locus.c <- cdims$locus
                               cdims$locus.c [!is.na(cdims$id)] <- round(predict(loess(locus ~ embdim, data=cdims, span=1)),0)} # loess correction
                             if(correction=="constant"){cdims$locus.c <- cdims$locus
                               cdims$locus.c [(nrow(cdims)-ttail+1):nrow(cdims)] <- cdims$locus.c [(nrow(cdims)-ttail+1)]} # constant epsilon correction
                             if(correction=="increasing"){cdims$locus.c <- cdims$locus
                               cdims$locus.c [(nrow(cdims)-ttail+1):nrow(cdims)] <- round(seq(cdims$locus.c [(nrow(cdims)-ttail+1)], cdims$locus.c [(nrow(cdims)-ttail+1)] + add, length=ttail),0)} # constant increasing/decreasing epsilon correction
                             for (i in 1:(nrow(cdims))){
                               if(is.na(cdims$locus.c[i])){
                                 sel.c[[i]]<-NA
                                 cdims$rsq.c [i] <- NA
                                 cdims$eps.c [i] <- NA
                                 cdims$id.c [i] <- NA} else {
                                 cdims$rsq.c [i] <- b[cdims$locus.c [i],i]
                                 cdims$eps.c [i] <- M[cdims$locus.c [i],1]
                                 sel.c[[i]] <- c((cdims$locus.c[i]-(round(rang*prop.rang[i],0))):(cdims$locus.c[i]+(round(rang*prop.rang[i],0))))
                                 cdims$id.c [i] <- 1/as.numeric(lm(log(M[sel.c[[i]],(i+1)]) ~ log(M[sel.c[[i]],1]))$coef[2])
                               }
                             }


                             par(mfrow=c(4,1), mar=c(3,4.5,1,1))
                             # plot_c(cbind(M[,1],c*100), y1 = 85, y2=(max(c*100,na.rm=t)+5), ylab="R-squared", xlim=c(0.05,1))
                             # plot_c(cbind(M[,1],b*100), y1 = 85, y2=(max(b*100,na.rm=t)+5), ylab="R-squared*Var", xlim=c(0.05,1))
                             plot_c(cbind(M[,1],c*100), y1 = 80, y2=(max(c*100,na.rm=t)+5), ylab="Ln-Ln Slope", xlim=c(0.03,1))
                             plot_c(cbind(M[,1],b*100), y1 = 80, y2=100, ylab="Ln-Ln Slope*Var", xlim=c(0.03,1))
                             for (i in 2:nrow(cdims)){
                               lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ M[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
                             }
                             points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
                             points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
                             plot(id~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Info. dimension (id)", xlab="Embeddng dimension")
                             plot(id.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Info. dimension (id)", xlab="Embeddng dimension")

                             mm <-summary.lm(mblm(id.c ~ embdim, data=cdims[(nrow(cdims)-ttail+1):nrow(cdims),], repeated=T))$coefficients[2,c(1,2,4)]
                             id <- data.frame(id=mean(cdims$id.c[(nrow(cdims)-ttail+1):nrow(cdims)]),id.se=sd(cdims$id.c[(nrow(cdims)-ttail+1):nrow(cdims)])/sqrt(ttail))

                             lines(rep(id$id,ttail) ~ c((nrow(cdims)-ttail+1):nrow(cdims)), lwd=4, col="blue")

                             if(mm[3]>=0.05){
                               cond <- paste("Plateau reached at ", round(id$id,2), " +/- ", round(id$id.se,2), "; Pval=", round(mm[3],5), sep="")
                             } else {
                               cond <- paste("Plateau was not reached, sorry... ", round(id$id,2), " +/- ", round(id$id.se,2), "; Pval=", round(mm[3],5), sep="")
                             }
                             print(cond)


                             # based on density function
                             aux <- numeric()
                             for (z in 2:ncol(ccc)){
                               # plot(density(na.omit(c[,z]), bw = 0.02), xlim=c(0.5,1))
                               a <- density(na.omit(ccc[,z]), bw = 0.02)
                               a$y <- a$y[a$x>(0.6)&a$x<(1)]
                               a$x <- a$x[a$x>(0.6)&a$x<(1)]
                               aa <- data.frame(x=a$x, y=a$y)
                               aa <- aa[order(aa$x, decreasing = T),]
                               aaa <- data.frame(embedd(aa$y, d=1, m=2))
                               aaa [(nrow(aaa)+1), c(1,2)] <- NA
                               aaa$res <- aaa$V1.1 -aaa$V1.0
                               aa <- cbind(aa, aaa)
                               site <- aa$x[which(aa$res<0)][1]
                               if (class(site)=="integer"){site <- aa$x[which(aa$y==max(aa$y))]}
                               aux [z] <- 1/(1-site)
                             }

                             aabb <- data.frame(a=aux[(length(aux)-4):length(aux)], b=c(1:5))
                             mm <-summary.lm(mblm(a ~ b,dataframe = aabb, repeated=T))$coefficients[2,c(1,2,4)]
                             aux2 <- data.frame(id=mean(aux[(length(aux)-4):length(aux)]),se=sd(aux[(length(aux)-4):length(aux)])/sqrt(5), pval=as.numeric(mm[3]))
                             par(mfrow=c(2,1), mar=c(3,4.5,1,1))
                             plot(aux, pch=21, bg="red", las=1, ylab="Info. Dimension (D1)", xlab="Embedding dimension")
                             lines(rep(aux2$id,5) ~ c((max(dims)-4):max(dims)), col="blue", lwd=2)
                             plot_c(cbind(M[,1],(1/(1-ccc[,-1]))), y1 = 0.5, y2=(max((1/(1-ccc[,-1])),na.rm=t)+0.5), ylab="Ln-Ln Slope", xlim=c(0.03,1))
                             return(list(slopes= cbind(M[,1],(1/(1-ccc[,-1]))), rsq.method=cbind(id,pval=round(mm[3],5)), dens.method=aux2))
                           }
                           ## Correlation dimension function ##
                           cd.calc <- function(d, exp.smooth=F, add=0, rang=100, prop.rang.max=0.5, prop.rang.min=0.5, ttail=5, dims=NA, w.var=0.5, tails=F, nontails=13:18, correction="loess"){ # correction="loess", "constant", "increasing"
                             # add <- 0 # try 100 for nee
                             # rang <- 10 # fix 100 for nee
                             # prop.rang.max <- 0.5 # 0.5 equals rang*2 + 1
                             # prop.rang.min <- 0.5
                             # ttail <- 5
                             # w.var <- 0.5 # variability weight, 0.5 means equal
                             if(is.na(dims[1])){dims <- 1:(ncol(d)-1)}
                             # tails <- F
                             # nontails <- c(13:17)
                             if(tails == F) {cttail <- ((length(dims)-ttail+1):length(dims))} else {cttail <- nontails}

                             ## smooth scalling exponents?
                             if(exp.smooth==T){
                               for (i in 1:ncol(d)){
                                 d[,i] <- predict(loess(d[,i]~c(1:length(d[,i])),span = 0.15))
                               }
                             }

                             ### starts running
                             x <- d[,c(1,(dims+1))]
                             rang <- round(rang,digit=0)
                             ttail <- round(ttail, digit=0)
                             prop.rang <- seq(prop.rang.max, prop.rang.min, length=(ncol(x)-1))
                             sel <- list()
                             cdims <- data.frame(embdim=c(1:(ncol(x)-1)),d2=rep(NA,times=(ncol(x)-1)), eps=NA, rsq=NA, locus=NA)
                             b <- matrix(ncol=(ncol(x)-1), nrow=nrow(x))
                             c <- b
                             f <- matrix(ncol=ncol(c), nrow=nrow(c))
                             f[,c(1,2)] <- 0
                             x[x==0] <- NA
                             for (i in 1:(ncol(x)-1)){
                               for (j in (rang+1):(nrow(x)-rang)){
                                 if (length(which(is.na(x[(j-rang):(j+rang),(i+1)])))>=(rang/2)){b [j,i] <- NA} else {
                                   md <- summary(lm(log(x[(j-rang):(j+rang),(i+1)])~ log(x[(j-rang):(j+rang),1])))
                                   b [j,i] = md$r.squared
                                   c [j,i] = md$coefficients[2,1]}
                               }
                             }

                             # for (y in 2:ncol(c)){
                             #   f [,y] <- abs(c[,y]-c[,y-1])/c[,y-1]
                             # } # substraction

                             # calculate variability (estability=1-PV) per epsilon for ech band
                             for (i in 3:ncol(c)){
                               for (w in 1:nrow(c)){
                                 if(any(is.na(c(c[w,i],c[w,i-1],c[w,i-2])))) {f [w,i] <- 0} else
                                 {f [w,i] <- pv.fun(c(c[w,i],c[w,i-1],c[w,i-2]))}
                               }
                             } # PV 3 bands

                             # # calculate stability (1-PV) per epsilon all bands together
                             # for (w in 1:nrow(c)){
                             #   if(any(is.na(c(c[w,])))) {f [w,1] <- NA} else
                             #   {f [w,1] <- pv.fun(c(c[w,]))}
                             # }# PV all bands
                             # f [,-1] <- f[,1]

                             # correct matrices for var.weight
                             f <- (1-f)*w.var # convert to stability
                             summary (f)
                             b <- b*(1-w.var)

                             # selection of site
                             for (i in 1:(ncol(x)-1)){
                               # b[!is.finite(b[,i]),i] <- NA
                               # maximum of the series
                               cdims$rsq [i] <- max((f[,i])+b[,i],na.rm=T) # maximum rsq
                               cdims$locus[i]<- (which((f[,i])+b[,i]==cdims$rsq[i])) # place max rsq
                               cdims$eps [i] <- x[cdims$locus[i],1] # epsilon of max rsq
                               sel[[i]] <- c((cdims$locus[i]-(round(rang*prop.rang[i],0))):(cdims$locus[i]+(round(rang*prop.rang[i],0))))
                               cdims$d2 [i] <- as.numeric(lm(log(x[sel[[i]],(i+1)]) ~ log(x[sel[[i]],1]))$coef[2])
                             }

                             ## correcting selection ##
                             sel.c <- list()
                             cdims$locus.c <- round(predict(loess(locus ~ embdim, data=cdims, span=1)),0) # smooth-only correction
                             if(correction=="loess"){cdims$locus.c <- cdims$locus} # no correction
                             if(correction=="constant"){cdims$locus.c [(ncol(b)-ttail+1):ncol(b)] <- cdims$locus.c [(ncol(b)-ttail+1)]} # constant epsilon correction
                             if(correction=="increasing"){cdims$locus.c [(ncol(b)-ttail+1):ncol(b)] <- round(seq(cdims$locus.c [(ncol(b)-ttail+1)], cdims$locus.c [(ncol(b)-ttail+1)] + add, length=ttail),0)} # constant increasing/decreasing epsilon correction
                             for (i in 1:(ncol(x)-1)){
                               cdims$rsq.c [i] <- b[cdims$locus.c [i],i]+(f[cdims$locus.c [i],i])
                               cdims$eps.c [i] <- x[cdims$locus.c [i],1]
                               sel.c[[i]] <- c((cdims$locus.c[i]-(round(rang*prop.rang[i],0))):(cdims$locus.c[i]+(round(rang*prop.rang[i],0))))
                               cdims$d2.c [i] <- as.numeric(lm(log(x[sel.c[[i]],(i+1)]) ~ log(x[sel.c[[i]],1]))$coef[2])
                             }


                             # D2 based on density function
                             aux <- numeric()
                             dims <- dims
                             lim <- 0.05
                             L <- c; L[L<lim] <- NA; L <- na.omit(L)
                             for (z in 3:length(dims)){
                               # plot(density(na.omit(c[,z]), bw = 0.08))
                               a <- density(L[,(z-2):z], bw = 0.07)
                               aa <- data.frame(x=a$x, y=a$y)
                               # for first maximum density
                               # aa <- aa[order(aa$x, decreasing = T),]
                               # aaa <- data.frame(embedd(aa$y, d=2, m=2))
                               # aaa [(nrow(aaa)+1):(nrow(aaa)+2), c(1,2)] <- NA
                               # aaa$res <- round((aaa$V1.2 - aaa$V1.0)/aaa$V1.0, digit=3)
                               # aa <- cbind(aa, aaa)
                               # site <- aa$x[which(aa$res<(-0.01))][1] # chosing first maximum
                               # if (class(site)=="integer"){site <- aa$x[which(aa$y==max(aa$y))]}
                               # for maximum density
                               site <- aa$x[which(aa$y==max(aa$y))] # slope at maximum density
                               aux [z] <- site

                               if (z==length(dims)){
                                 t <- density(L, bw = 0.08)
                                 tt <- data.frame(x=t$x, y=t$y)
                                 # for first maximum
                                 # tt <- tt[order(tt$x, decreasing = T),]
                                 # ttt <- data.frame(embedd(tt$y, d=2, m=2))
                                 # ttt [(nrow(ttt)+1):(nrow(ttt)+2), c(1,2)] <- NA
                                 # ttt$res <- round((ttt$V1.2 - ttt$V1.0)/ttt$V1.0, digit=3)
                                 # tt <- cbind(tt, ttt)
                                 # autt <- mean(tt$x[(which(tt$res<(-0.01))[1]-2):(which(tt$res<(-0.01))[1]+2)])
                                 # autt.se <- sd(tt$x[(which(tt$res<(-0.01))[1]-2):(which(tt$res<(-0.01))[1]+2)])/sqrt(5)
                                 # if (class(site)=="integer"){autt <- tt$x[which(tt$y==max(tt$y))]}

                                 # for maximum density
                                 autt <- mean(tt$x[(which(tt$y==max(tt$y))-2):(which(tt$y==max(tt$y))+2)])
                                 autt.se <- sd(tt$x[(which(tt$y==max(tt$y))-2):(which(tt$y==max(tt$y))+2)])/sqrt(5)
                               }
                             }
                             aabb <- data.frame(a=aux[(length(aux)-4):length(aux)], b=c(1:5))
                             mm <-summary.lm(mblm(a ~ b,dataframe = aabb, repeated=T))$coefficients[2,c(1,2,4)]
                             aux2 <- data.frame(cd=c(mean(aux[(length(aux)-4):length(aux)]),autt),se=c(sd(aux[(length(aux)-4):length(aux)])/sqrt(5),autt.se), pval=c(as.numeric(mm[3]),NA))
                             rownames(aux2) <- c("Single", "Overall")

                             ## minimum slope (5) ##
                             slataux <- NA
                             plataux <- NA
                             for (i in 5:length(cdims$embdim)){
                               aaa <- summary.lm(mblm(d2.c ~ embdim,dataframe = cdims[c((i-4):i),], repeated=T))$coefficients[2,]
                               slataux[i] <- abs(as.numeric(aaa[1]))
                               plataux[i] <- as.numeric(aaa[4])
                             }
                             d2.minslope <- mean(cdims$d2.c[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])
                             d2.minslope.se <- sd(cdims$d2.c[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])/sqrt(5)
                             d2.minslope.p <- plataux[which(slataux==min(slataux, na.rm=T))]

                             # graphic output
                             par(mfrow=c(5,1), mar=c(3,4.5,1,1))
                             plot_b(na.omit(cbind(x[,1],(b+f)*100)), y1 = 60, y2=100, ylab="R-squared x Stability (1-PV)")
                             for (i in 2:nrow(cdims)){
                               lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ x[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
                             }
                             points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
                             points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
                             plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
                             plot(d2~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Correlation dimension (D2)", xlab="Embeddng dimension")
                             plot(d2.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Corrected D2", xlab="Embeddng dimension")

                             # estimate density of D2
                             dn <- density(cdims$d2.c);dn <- dn$x[which(dn$y==max(dn$y))]
                             # estimate CD
                             mm <-summary.lm(mblm(d2.c ~ embdim, data=cdims[cttail,], repeated=T))$coefficients[2,c(1,2,4)]
                             d2 <- data.frame(d2=mean(cdims$d2.c[cttail]),d2.se=sd(cdims$d2.c[cttail])/sqrt(length(cttail)))
                             # plot line on graph
                             lines(rep(d2$d2,length(cttail)) ~ cttail, lwd=4, col="blue")
                             lines(rep(dn,length(dims)) ~ c(1:length(dims)), lwd=4, col="black")
                             lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

                             # Plot density estimation of D2
                             plot(aux, pch=21, bg="red", las=1, ylab="Corr. Dimension (D2)", xlab="Embedding dimension")
                             lines(rep(aux2$cd[1],5) ~ c((length(dims)-4):length(dims)), col="blue", lwd=2)
                             lines(rep(aux2$cd[2],length(1:max(dims))) ~ c(1:max(dims)), col="blue", lwd=2)

                             # print message
                             if(mm[3]>=0.05){
                               cond <- paste("End plateau reached at ", round(d2$d2,2), " +/- ", round(d2$d2.se,2), "; Pval=", round(mm[3],5), sep="")
                             } else {
                               cond <- paste("End plateau was not reached, sorry... ", round(d2$d2,2), " +/- ", round(d2$d2.se,2), "; Pval=", round(mm[3],5), sep="")
                             }
                             print(cond)

                             # print message previous plateau?
                             if(d2.minslope.p>=0.05){
                               cond <- paste("Min slope plateau reached at ", round(d2.minslope,2), " +/- ", round(d2.minslope.se,2), "; Pval=", round(d2.minslope.p,5), sep="")
                             } else {
                               cond <- paste("Plateau was not reached, minimum slope at ", round(d2.minslope,2), " +/- ", round(d2.minslope.se,2), "; Pval=", round(d2.minslope.p,5), sep="")
                             }
                             print(cond)

                             ##print result rsq method
                             # cbind(d2,pval=round(mm[3],5), dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1))
                             ## print results density estimation of D2
                             # cbind(aux2[1,], aux2[2,-3], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))
                             par(mfrow=c(1,1), mar=c(3,4.5,1,1))
                             plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
                             return(list(slopes=x,
                                         param=list(scal.exp=d, c=c, b=b, f=f, prop.rang=prop.rang, rang=rang, cttail=cttail,
                                                    dims=dims, aux=aux, aux2=aux2, slataux=slataux), d2=d2, dn=dn, cdims=cdims, d2.minslope=d2.minslope,
                                         rsq.method=data.frame(d2, slope=round(mm[1],3), pval=round(mm[3],5), d2.minslope=d2.minslope, d2.minslope.se=d2.minslope.se, d2.minslope.p=d2.minslope.p, dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1)),
                                         dens.method=data.frame(cd.dens.single=aux2[1,1], se.single=aux2[1,2],pval=aux2[1,3], cd.dens.overall=aux2[2,1], se.overall=aux2[2,2], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))))
                           }
                           cd.mfm <- function(var, tau="auto", delay.technique="ami", sel.method="first.minimum", extra.m=10, tw="auto", prop.rang.max=0.5, prop.rang.min=0.5, neps=1000, rang=100, eps.min=0.01){ # tau is embedding delay
                             # calculate delay (tau) if auto
                             if (tau=="auto"){
                               tau <- timeLag(var, technique = delay.technique, selection.method=sel.method, lag.max = 100, do.plot = F)
                               a <- print(paste("Delay (tau) =",tau))
                             }
                             a <- print(paste("Delay (tau) =",tau))
                             attract(var [1:c(round(0.25*length(var),0))], lag=tau, type="p", main= a) # show attractor
                             emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
                             if (tw=="auto"){
                               #Step 2: Compute Theiler window parameter (tw) required for false nearest
                               # neighbours test
                               #Step 2a: Autocorrelation function
                               lag.max=100
                               acf.run<-acf(var,lag.max, plot=F)
                               acf.out<-acf.run$acf #array of acf values
                               #Step 2b: Use embedding approach to calculate delay at which AMI hits
                               #its first minimum.
                               acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
                               acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
                               acf.hold<-matrix(0,acf.adj.length,1)
                               for (i in 1:acf.adj.length){ #loop to compute successfive value differences
                                 acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
                                 acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                               } #end iloop
                               #Step 2c: Estimate Theiler window (tw)
                               tw<-sum(acf.hold)
                             }
                             cdd <- d2(var, m = emb.dim+extra.m, d = tau, t = tw, eps.min = eps.min, neps=neps) # run d2 routine
                             return(cd_calc=cd.calc(cdd, dims=1:(emb.dim+extra.m), prop.rang.max = prop.rang.max, prop.rang.min = prop.rang.min, rang = rang))
                           }
                           cd.calc.plots <- function(cd.calc.obj){
                             x <- cd.calc.obj$slopes
                             c <- cd.calc.obj$param$c
                             b <- cd.calc.obj$param$b
                             f <- cd.calc.obj$param$f
                             prop.rang <- cd.calc.obj$param$prop.rang
                             rang <- cd.calc.obj$param$rang
                             cttail <- cd.calc.obj$param$cttail
                             slataux <- cd.calc.obj$param$slataux
                             d2.minslope <- cd.calc.obj$d2.minslope
                             aux <- cd.calc.obj$param$aux
                             aux2 <- cd.calc.obj$param$aux2
                             cdims <- cd.calc.obj$cdims
                             dims <- cd.calc.obj$param$dims
                             dn <- cd.calc.obj$dn
                             d2 <- cd.calc.obj$d2
                             # graphic output
                             par(mfrow=c(5,1), mar=c(3,4.5,1,1))
                             plot_b(na.omit(cbind(x[,1],(b+f)*100)), y1 = 60, y2=100, ylab="R-squared x Stability (1-PV)")
                             for (i in 2:nrow(cdims)){
                               lines(rep(cdims$rsq.c[i]*100, times=1+2*prop.rang[i]*rang) ~ x[c((cdims$locus.c[i]-prop.rang[i]*rang):(cdims$locus.c[i]+prop.rang[i]*rang)),1], col="red", lwd=1)
                             }
                             points(cdims$rsq*100 ~ cdims$eps, bg="blue", pch=21)
                             points(cdims$rsq.c*100 ~ cdims$eps.c, bg="red", pch=21)
                             plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")
                             plot(d2~embdim, data=cdims,las=1, bg="blue", pch=21, ylab="Correlation dimension (D2)", xlab="Embeddng dimension")
                             plot(d2.c~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Corrected D2", xlab="Embeddng dimension")
                             # plot line on graph
                             lines(rep(d2$d2,length(cttail)) ~ cttail, lwd=4, col="blue")
                             lines(rep(dn,length(dims)) ~ c(1:length(dims)), lwd=4, col="black")
                             lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

                             # Plot density estimation of D2
                             plot(aux, pch=21, bg="red", las=1, ylab="Corr. Dimension (D2)", xlab="Embedding dimension")
                             lines(rep(aux2$cd[1],5) ~ c((length(dims)-4):length(dims)), col="blue", lwd=2)
                             lines(rep(aux2$cd[2],length(1:max(dims))) ~ c(1:max(dims)), col="blue", lwd=2)

                             ##print result rsq method
                             # cbind(d2,pval=round(mm[3],5), dens.d2=dn, pv=round(100*pv.fun(cdims$d2.c[cttail]), digit=1))
                             ## print results density estimation of D2
                             # cbind(aux2[1,], aux2[2,-3], pv=round(100*pv.fun(aux[(length(aux)-4):length(aux)]), digit=1))
                             par(mfrow=c(1,1), mar=c(3,4.5,1,1))
                             plot_b(na.omit(cbind(x[,1],c)), y1 = 0.01, y2=max(c, na.rm=T), ylab="Local Exponents (slope)")

                           }
                           summary.cd.calc <- function(cd.calc.obj){
                             return(data.frame(cd.calc.obj$rsq.method,
                                               cd.calc.obj$dens.method))
                           }
                           #Code 7.3 Compute correlation dimension for time series using Takens estimator
                           cd_takens<-function(x,m_max) {
                             cd.m<-matrix(0,m_max,1) #store estimated correlation dimensions
                             for(j in 2:m_max) { #iterate over embedding dimensions (m)
                               #Step 1: Compute embedding delay and Theiler window
                               embed<-embed_udf(x)
                               d<-embed[[1]] #embedding delay
                               tw<-embed[[3]] #Theiler window
                               #Step 2: Compute embedded data matrix
                               library(tseriesChaos)
                               Mx<-embedd(x,j,d) #embedded data matrices
                               n<-nrow(Mx)
                               #Step 3: Compute distance matrix
                               library(fields)
                               dist<-rdist(Mx) #Distance matrix
                               dist.vec<-as.vector(dist)
                               #Step 4: Adjust distance matrix to Theiler window
                               #Step 4a: reduce to relevant rows and columns
                               dist.1<-dist[(tw+1):n,1:(n-tw)]
                               #Step 4b: reduce to relevant distances in each column
                               dist.2<-matrix(0,(n-tw),(n-tw)) #storage matrix for loop
                               for(i in 1:(n-tw)) { #iterate over columns of dist.1
                                 column<-dist.1[,i][i:(n-tw)]
                                 length(column)<-n-tw #make reduced columns same length for storage
                                 dist.2[,i]<-column
                               } #end loop i
                               #Step 5: Put distances in matrix into vector
                               dist.vec1<-as.vector(dist.2) #distances not satisfying Theiler window
                               #have NAs
                               dist.vec2<-na.omit(dist.vec1) #remove NAs, only distances satisfying
                               #Theiler window remain
                               if(tw==0) {distances<-dist.vec} else {distances<-dist.vec2}
                               #Step 6: Set upper threshold on distance
                               x.thresh<-0.5*sqrt(sum(x^2)/length(x)) #1/2 root mean squared error (rms)
                               distances.thresh<-distances[-c(which(distances>x.thresh))] #omit distances over threshold
                               #Step 7: Takens estimation of correlation dimension
                               cd<--1/mean(log(distances.thresh/x.thresh))
                               cd.m[j,]<-cd #vector storing correlation dimensions over range of
                               #embedding dimensions
                             } #end loop j
                             return(list(cd=cd.m, delay=d, tw=tw))
                           } #end user-defined function
                           cd_fertakens<-function(x, m_min=2, m_max="auto", d="ami", tw="auto", sel.meth="first.e.decay") {
                             #Step 1: Compute embedding delay (d), max embedding dimension (m_max) and Theiler window
                             if(d=="ami"){
                               d <- timeLag(x, technique = "ami", selection.method=sel.meth, lag.max = 100, do.plot = F)
                             }
                             if(d=="acf"){
                               d <- timeLag(x, technique = "acf", selection.method=sel.meth, lag.max = 100, do.plot = F)
                             }
                             # calculate embedding dimension if m_max="auto"
                             if (m_max=="auto"){
                               m_max <- 10+estimateEmbeddingDim(x, time.lag = d, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
                             }
                             cd.m<-matrix(0,m_max,1) #store estimated correlation dimensions
                             if (tw=="auto"){
                               #Step 2: Compute Theiler window parameter (tw) required for false nearest
                               # neighbours test
                               #Step 2a: Autocorrelation function
                               lag.max=100
                               acf.run<-acf(x,lag.max, plot=F)
                               acf.out<-acf.run$acf #array of acf values
                               #Step 2b: Use embedding approach to calculate delay at which AMI hits
                               #its first minimum.
                               acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
                               acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
                               acf.hold<-matrix(0,acf.adj.length,1)
                               for (i in 1:acf.adj.length){ #loop to compute successfive value differences
                                 acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
                                 acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                               } #end iloop
                               #Step 2c: Estimate Theiler window (tw)
                               tw<-sum(acf.hold)
                             }
                             #iterate over embedding dimensions (m)
                             for(j in m_min:m_max) {
                               #Step 2: Compute embedded data matrix
                               Mx<-embedd(x,j,d) #embedded data matrices
                               n<-nrow(Mx)
                               #Step 3: Compute distance matrix
                               dist<-rdist(Mx) #Distance matrix
                               dist.vec<-as.vector(dist)
                               #Step 4: Adjust distance matrix to Theiler window
                               #Step 4a: reduce to relevant rows and columns
                               dist.1<-dist[(tw+1):n,1:(n-tw)]
                               #Step 4b: reduce to relevant distances in each column
                               dist.2<-matrix(0,(n-tw),(n-tw)) #storage matrix for loop
                               for(i in 1:(n-tw)) { #iterate over columns of dist.1
                                 column<-dist.1[,i][i:(n-tw)]
                                 length(column)<-n-tw #make reduced columns same length for storage
                                 dist.2[,i]<-column
                               } #end loop i
                               #Step 5: Put distances in matrix into vector
                               dist.vec1<-as.vector(dist.2) #distances not satisfying Theiler window
                               #have NAs
                               dist.vec2<-na.omit(dist.vec1) #remove NAs, only distances satisfying
                               #Theiler window remain
                               if(tw==0) {distances<-dist.vec} else {distances<-dist.vec2}
                               #Step 6: Set upper threshold on distance
                               x.thresh<-0.5*sqrt(sum(x^2)/length(x)) #1/2 root mean squared error (rms)
                               distances.thresh<-distances[-c(which(distances>x.thresh))] #omit distances over threshold
                               #Step 7: Takens estimation of correlation dimension
                               cd<--1/mean(log(distances.thresh/x.thresh))
                               cd.m[j,]<-cd #vector storing correlation dimensions over range of
                               #embedding dimensions
                             } #end loop j

                             ## minimum slope (5) ##
                             cdims <- data.frame(embdim=c(1:length(cd.m)), cd=as.numeric(cd.m))
                             slataux <- NA
                             plataux <- NA
                             for (i in 5:length(cdims$embdim)){
                               aaa <- summary.lm(mblm(cd ~ embdim,dataframe = cdims[c((i-4):i),], repeated=T))$coefficients[2,]
                               slataux[i] <- abs(as.numeric(aaa[1]))
                               plataux[i] <- as.numeric(aaa[4])
                             }
                             d2.minslope <- mean(cdims$cd[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])
                             d2.minslope.se <- sd(cdims$cd[(which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))])/sqrt(5)
                             d2.minslope.p <- plataux[which(slataux==min(slataux, na.rm=T))]
                             plot(cd~embdim, data=cdims,las=1, bg="red", pch=21, ylab="Correlation dimesion (D2)", xlab="Embeddng dimension")

                             # estimate CD
                             mm <-summary.lm(mblm(cd ~ embdim, data=tail(cdims,5), repeated=T))$coefficients[2,c(1,2,4)]
                             d2 <- data.frame(d2=mean(tail(cdims$cd,5)),d2.se=sd(tail(cdims$cd,5))/sqrt(length(5)), d2.slope= as.numeric(mm[1]), pval=as.numeric(mm[3]))
                             # plot line on graph
                             lines(rep(d2$d2,5) ~ tail(cdims$embdim,5), lwd=4, col="blue")
                             lines(rep(d2.minslope,5) ~ c((which(slataux==min(slataux, na.rm=T))-4):which(slataux==min(slataux, na.rm=T))), lwd=4, col="red")

                             return(list("cds"=cdims,
                                         "cd"=data.frame(d2.tail=d2$d2, d2.tail.se=d2$d2.se, d2.tail.slope.pval=d2$pval,
                                                         d2.minslope=d2.minslope, d2.minslope.se=d2.minslope.se, d2.minslope.p=d2.minslope.p),
                                         "delay"=d, "tw"=tw))
                           } #end user-defined function
                           lorenz_udf<-function(x0,y0,z0,sigma,beta,rho,t.end,delta) {
                             #Initial conditions and parameters
                             state<-c(x=x0,y=y0,z=z0) #initial conditions
                             parameters<-c(sigma,beta,rho) #parameters giving chaotic dynamics
                             #ODE model
                             model<-function(t,state,parameters){
                               with(as.list(c(state,parameters)),{
                                 dx<- sigma*(y-x) #Lorenz equations
                                 dy<- x*(rho-z)-y
                                 dz<- x*y-beta*z
                                 list(c(dx,dy,dz))
                               }) #end with (as.list...
                             } #end model function
                             #Solution
                             times<-seq(0,t.end,by=delta) #integration step
                             library(deSolve) #ODE solver package
                             out<-ode(y=state,times=times,func=model,parms=parameters,method="lsoda")
                             #Solution variables
                             x<-out[,"x"];y<-out[,"y"];z<-out[,"z"]
                             results<-list(x,y,z)
                             return(results)
                           } #end user-defined function
                           embed_udf <-function(x){
                             #Step 1: Calculate embedding delay
                             #Step 1a. Compute average mutual information (AMI) function
                             library(tseriesChaos)
                             mutual.out<-mutual(x) #mutual(tseriesChaos)
                             #Step 1b: Use embedding approach to calculate delay at which AMI hits
                             #its first minimum
                             mutual.em<-embedd(mutual.out,2,1) #embedd(tseriesChaos)
                             mutual.adj.length<-length(mutual.out)-1 #lose 1 observation to delay
                             mutual.hold<-matrix(0,mutual.adj.length,1)
                             for (i in 1:mutual.adj.length){ #loop to compute successfive value differences
                               mutual.test<-if(mutual.em[i,1]>mutual.em[i,2])TRUE else break
                               mutual.hold[i,1]<-mutual.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                             } #end iloop
                             mutual.hold.sum<-sum(mutual.hold)
                             #Step 1c: Estimate embeddeding delay (d). If the mutual information function is
                             #decreasing across all 20 delays, set delay at max = 20
                             d<-if(mutual.hold.sum<20)mutual.hold.sum else 20 #Embedding delay
                             #Step 2: Compute Theiler window parameter (tw) required for false nearest
                             # neighbours test
                             #Step 2a: Autocorrelation function
                             lag.max=100
                             acf.run<-acf(x,lag.max)
                             acf.out<-acf.run$acf #array of acf values
                             #Step 2b: Use embedding approach to calculate delay at which AMI hits
                             #its first minimum.
                             acf.em<-embedd(acf.out,2,1) #embedd(tseriesChaos)
                             acf.adj.length<-length(acf.out)-1 #lose 1 observation to lag
                             acf.hold<-matrix(0,acf.adj.length,1)
                             for (i in 1:acf.adj.length){ #loop to compute successfive value differences
                               acf.test<-if(acf.em[i,1]>acf.em[i,2])TRUE else break
                               acf.hold[i,1]<-acf.test #"TRUE' = 1 in R, so min delay occurs at sum(TRUE)
                             } #end iloop
                             #Step 2c: Estimate Theiler window (tw)
                             tw<-sum(acf.hold)
                             #Step 3: Embedding dimension (m)
                             #Step 3a: False nearest neighbours function
                             m.max<-6 #maximum number of embedding dimensions to consider
                             fn.out<-false.nearest(x,m.max,d,tw) #false.nearest(tseriesChaos)
                             fn.out[is.na(fn.out)] <- 0 #set NA in fn.out to zero
                             #plot(fn.out)
                             #Step 3b: Find delay at which false nearest neighbours decrease below set tolerance
                             #Output vector of fnn percentages from fn.out
                             fnp<-c(fn.out[1],fn.out[3],fn.out[5],fn.out[7],fn.out[9],fn.out[11])
                             fnp.tol<-fnp>0.15 #If fnp greater than tolerance of 15%, T entered into fnp.tol
                             fnp.tol.sum<-sum(fnp.tol) #sum up number of T's
                             m<-if(fnp.tol.sum<m.max)fnp.tol.sum+1 else m.max #Embedding dimension
                             #Step 4: Embed time series (Mx)
                             #If m=1, embedd routine crashes due to 'subscript out of bounds' error--need to
                             #guarantee an embedding dimension of at least two:
                             if(m<=1){m<-2} else {m}
                             Mx<-embedd(x,m,d) #embedd(tseriesChaos)
                             #Results
                             results.embed_udf<-list(d,m,tw,Mx)
                             return(results.embed_udf)
                           } #end user-defined function
                           season.dates <-function(st.date, nyears){
                             yini <- as.numeric(substring(as.character(st.date), c(1), c(4)))
                             yys <- rep(yini:(yini+(nyears-1)), each=4)
                             mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=nyears)
                             mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=nyears)
                             res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
                             return(res)
                           }
                           season.dates.yrs <-function(yys){
                             mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=length(yys))
                             mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=length(yys))
                             yys <- rep(yys, each=4)
                             res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
                             return(res)
                           }


                           date.fun <- function(date.fluxnet){
                             return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
                           }
                           #### prova ####
                           # library (deSolve)
                           # library (tseriesChaos)
                           # library (fields)
                           #
                           # ## functions to perform a logistic map simulaiton
                           # f.x<- function(x,r){
                           #   r*x*(1-x)
                           # }
                           # f.temp<-function(xinit,nstep,r){ # starting function f.temp
                           #   xt<- numeric()
                           #   x<- xinit
                           #   xt[1]<- x
                           #   for(i in 2:nstep){
                           #     y<- f.x(x,r)
                           #     x<- y
                           #     xt[i]<- x
                           #   }
                           #   # plot(xt,type="b",xlab="time",ylab="x(t)",
                           #   #      cex.lab=1.7,cex.axis=1.3,lwd=2)
                           #   return(xt)
                           #   #xt # comment to skip iterates
                           # } # ending function f.temp
                           # ## function to draw the time plot ##
                           # f.temp.graph<-function(xinit,nstep,r){ # starting function f.temp
                           #   xt<- numeric()
                           #   x<- xinit
                           #   xt[1]<- x
                           #   for(i in 2:nstep){
                           #     y<- f.x(x,r)
                           #     x<- y
                           #     xt[i]<- x
                           #   }
                           #   plot(xt,type="b",xlab="time",ylab="x(t)",
                           #        cex.lab=1.7,cex.axis=1.3,lwd=2)
                           #   #xt # comment to skip iterates
                           # } # ending function f.temp
                           # ### parameters and initial conditions
                           # # vary r: r<- 2.8, r<- 3.2, r<- 3.5, r<- 4
                           # xinit<- 0.01
                           # nstep<- 10000
                           # r<- 4
                           # f.temp.graph(xinit,25,r)
                           # logistmap.ts <-f.temp(xinit,nstep,r) # call up the time plot
                           # x <- logistmap.ts
                           # # Generate Lorenz data with user-defined function 'lorenz_udf'
                           # lorenz_results<-lorenz_udf(x0=1,y0=1,z0=1,sigma=10,beta=8/3,rho=28,
                           #                            t.end=100,delta=0.01)
                           # x <- lorenz_results[[1]]
                           # # initiating routine
                           # tau <- timeLag(var, technique = "ami", selection.method="first.e.decay", lag.max = 100, do.plot = T)
                           # a <- print(paste("Delay (tau) =",tau))
                           # attract(var [1:4000], lag=tau, type="p", main= a) # show attractor
                           # emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 30) # calculating embeding dimension #
                           #
                           #
                           #
                           # # using cd_takens
                           # x <- logistmap.ts
                           # attract(x [1:4000], lag=10, type="p", main= a) # show attractor
                           # emb.dim <- estimateEmbeddingDim(x, time.lag = 10, max.embedding.dim = 30) # calculating embeding dimension #
                           #
                           # m_max<-10 #maximum embedding dimension
                           # cd_m<-cd_takens(x,m_max=m_max)
                           # cd_m
                           # a <- Sys.time()
                           # cd_m2<-cd_fertakens(x,m_min=2, m_max="auto", d = "ami", sel.meth = "first.e.decay") # sel.meth="first.e.decay" (default) or "first.minimum" (like in cd_takens)
                           # cd_m2
                           # Sys.time() - a
                           # attract(x [1:4000], lag=cd_m$delay, type="l", main= a) # show attractor
                           # attract(x [1:4000], lag=1, type="p", main= a) # show attractor
                           #
                           #
                           # m<-1:m_max #revised x-axis
                           # cd.m.plot<-plot(m,cd_m,xaxt="n",xlab="",ylab="correlation dimension",
                           #                 pch=15,type="b")
                           # #Custom x-axis, side=1 is x-axis, "at" defines 'tick-mark' numbers
                           # axis(side=1,at=1:length(cd_m))
                           # #Label custom x-axis, "line=2.5" puts label below tick-mark numbers
                           # mtext(side=1,"embedding dimension",line=2,cex=0.8)
                           # #Label points in plot
                           # round(cd_m,digits=2)
                           #
                           #
                           #
                           # ### old stile CD ###
                           # var <- x
                           # # initiating routine
                           # tau <- timeLag(var, technique = "ami", selection.method="first.e.decay", lag.max = 100, do.plot = T)
                           # a <- print(paste("Delay (tau) =",tau))
                           # attract(var [1:4000], lag=tau, type="p", main= a) # show attractor
                           # emb.dim <- estimateEmbeddingDim(var, time.lag = tau, max.embedding.dim = 25, do.plot=F) # calculating embeding dimension #
                           # a <- Sys.time()
                           # cd.lor.ami.nf.1 <- d2(var, m = emb.dim+10, d = tau, t = 64, eps.min = 0.1, neps=1000) # run d2 routine
                           # # id.lor.ami.nf.1 <- infDim(var, min.embedding.dim = emb.dim, max.embedding.dim = emb.dim+20, time.lag= tau,
                           # #                           min.fixed.mass = 0.01, max.fixed.mass = 1, number.fixed.mass.points = 500,
                           # #                           radius=mean(abs(var[-1]-var[-length(var)]))*0.95, theiler.window = 200, do.plot=F)
                           # ml.lor.ami.nf.1 <- maxLyapunov(var, sampling.period=0.005, min.embedding.dim = emb.dim+1, max.embedding.dim = emb.dim + 10,
                           #                                time.lag = tau, radius=1, max.time.steps=4000, do.plot=FALSE)
                           #
                           # Sys.time() - a
                           #
                           # # results
                           # plot_c(cd.lor.ami.nf.1) # Plot correlation integrals over m (for scaling range)
                           # plot(id.lor.ami.nf.1) # Plot id results
                           # plot(ml.lor.ami.nf.1,type="l", xlim = c(0,8))
                           # ml.lor.ami.nf.1.est <- estimate(ml.lor.ami.nf.1, regression.range = c(2,5),
                           #                                 do.plot = T,type="l"); cat("expected: 0.906  --- estimate: ", ml.lor.ami.nf.1.est,"\n")
                           # # a <- id.calc(id.lor.ami.nf.1, dims=15:20, w.var = 0.85, correction="loess",add = 0)
                           # # cbind(a$rsq.method, a$dens.method)
                           # # locator()
                           # a <- cd.calc(cd.lor.ami.nf.1, dims=1:(emb.dim+10))
                           # cbind(a$rsq.method, a$dens.method)
                           # locator()
                           # cd.lor.ami.nf.1[,1]
                           #
                           #
                           #
                           # cd.mfm(x, tau="auto", delay.technique="ami", sel.method="first.e.decay")
                           # a <- cd_fertakens(x[1:5000])
                           #

                           #### prova flux ####
                           # fi.hyy <- read.table(file="../../fluxnet/FLX_FI-Hyy_FLUXNET2015_SUBSET_HH_1996-2014_1-3.csv", header=T, sep=",")
                           # head(fi.hyy)
                           # table(fi.hyy$NEE_VUT_REF_QC)
                           # # Data quality flags
                           # # 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
                           #
                           # # calculate time
                           # fi.hyy$year <- NA; fi.hyy$month <- NA; fi.hyy$day<-NA; fi.hyy$hour <- NA; fi.hyy$min <- NA
                           # for (i in 1:nrow(fi.hyy)){
                           #   a <-substring(as.character(fi.hyy$TIMESTAMP_END[i]), c(1,5,7,9,11), c(4,6,8,10,12))
                           #   fi.hyy$year [i] <- as.numeric(a[1])
                           #   fi.hyy$month [i]<- as.numeric(a[2])
                           #   fi.hyy$day [i]<- as.numeric(a[3])
                           #   fi.hyy$hour [i]<- as.numeric(a[4])
                           #   fi.hyy$min [i]<- as.numeric(a[5])
                           # }
                           #
                           # table(fi.hyy$year[which(fi.hyy$NEE_VUT_REF_QC==3)])
                           #
                           #
                           # subfi.hyy <- subset(fi.hyy, TIMESTAMP_END>200001010000&TIMESTAMP_END<200101010000)
                           # var <- subfi.hyy$NEE_VUT_REF
                           # var <- embedd(var, 20, 1)
                           # var <- (var[,1]+var[,2]+var[,3]+var[,4]+var[,5]+var[,6])/6
                           #
                           # head(var)
                           #
                           # var <- logistmap.ts
                           # var <- lorenz_results[[1]]
                           #
                           # tau <- timeLag(var, technique = "ami", selection.method="first.minimum", lag.max = 100, do.plot = T)
                           # a <- print(paste("Delay (tau) =",tau))
                           # attract(var [1:10000], lag=tau, type="l", main= a) # show attractor
                           # # pca
                           # var <- prcomp(embedd(var, 15, 1), scale.=T, center=T)
                           # summary (var)
                           # var <- var$x[,c(1:3)]
                           # attract.or(var, type="l")
                           #
                           # library (Rdimtools)
                           # ## generate three different dataset
                           # ## compute
                           # out1 = est.correlation(var, method = "cut")
                           # plot(log(out1$r), log(out1$Cr), main="swiss roll")
                           #
                           # out1 <- numeric()
                           # for (i in 10:ncol(var)){
                           # out1 [i] = est.correlation(var[,c(10:i)], method = "cut")$estdim
                           # }
                           # plot(out1)
                           #
                           #
                           # ## visually verify : all should have approximate slope of 2.
                           # opar <- par(no.readonly=TRUE)
                           # par(mfrow=c(1,3))
                           # plot(log(out2$r), log(out2$Cr), main="ribbon")
                           # plot(log(out3$r), log(out3$Cr), main="twinpeaks")
                           # par(opar)
                           #
                           #
                           # subfi.hyy <- subset(fi.hyy, TIMESTAMP_END>200001010000&TIMESTAMP_END<200201010000)
                           # subfi.hyy$sel <- c(rep(c(1,2,3), times=nrow(subfi.hyy)/3),c(1,2))
                           # # aux <-  embedd(subfi.hyy$NEE_VUT_REF, 20, 1)
                           # # subfi.hyy$var <- c(rep(NA,19),c(aux[,1]+aux[,2]+aux[,3]+aux[,4]+aux[,5]+aux[,6])/6) # 3 hour average
                           # subfi.hyy <- subfi.hyy[which(subfi.hyy$sel==1),]
                           # var <- subfi.hyy$NEE_VUT_REF
                           # var <- subfi.hyy$P_F
                           # # var <- embedd(var, 20, 1)
                           # # var <- (var[,1]+var[,2]+var[,3]+var[,4]+var[,5]+var[,6])/6 # 3 hour average
                           # summary(var)
                           # attract(var, lag=6, type="l")
                           # # increasing eps.min increases chance of ups and downs in local scaling exponents
                           # # if too low you may have to reduce the proportion of the range (slopes separate more)
                           # tt <- Sys.time()
                           # a1 <- cd.mfm(var, tau="auto", delay.technique="ami", sel.method="first.minimum", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
                           # # a2 <- cd.mfm(var, tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
                           # # cd.mfm(var[(4320*8):(4320*9)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = 500*0.2, neps=500, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.1) # rang=20% works well
                           # Sys.time() - tt
                           #
                           # a <- cd_fertakens(var, sel.meth = "first.e.decay")
                           # a
                           # b <- cd_fertakens(var, sel.meth = "first.minimum")
                           # b

                           #### Starts analyses ####
                           #### Importing HH data all sites ####
                           # setwd("~/dades/chaos/fluxchaos")
                           # load("~/dades/biodiver_flux/sbioflux.Rdata")
                           # unique(sbioflux$site)
                           # # data-list for all 62 sites
                           # site.list <- list()
                           # file_names <- dir("~/dades/fluxnet/", pattern="_HH_.*\\.csv$") # where you have your files
                           # file_split <- strsplit(file_names, split = "_")
                           # a <- character() # name plot
                           # for (i in 1:length(file_split)){
                           #   a [i] <- file_split[[i]][2]
                           # }
                           # b <- character() # years measurements
                           # for (i in 1:length(file_split)){
                           #   b [i] <- as.numeric(strsplit(file_split[[i]][6], split="-")[[1]])[2] - as.numeric(strsplit(file_split[[i]][6], split="-")[[1]])[1]
                           # }
                           # a <- data.frame("name"=a,"nyears"=as.numeric(b))
                           #
                           # files <- lapply(paste("~/dades/fluxnet/", file_names[which(a$name%in%unique(sbioflux$site))], sep=""), read.delim, sep = ",")
                           # names(files) <- a$name[which(a$name%in%unique(sbioflux$site))]
                           #
                           # save(files, file="./fluxchaos.Rdata") # 13/05/2020
                           #
                           load("./fluxchaos.Rdata")
                           #### CDs: Site, Annual and Seasonal - AU-DaP site #1 ####
                           ## AU-DaP
                           data <- files[[1]]
                           # Data quality flags
                           # 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
                           table(data$NEE_VUT_REF_QC)
                           # check data quality with time
                           plot(data$NEE_VUT_REF_QC, type="l") # fluxes
                           plot(data$TA_F_QC, type="l") # temperature
                           plot(data$P_F_QC, type="l") # precipitation
                           plot(data$WS_F_QC, type="l") # wind speed
                           plot(data$VPD_F_QC, type="l") # VPD
                           # Cut start and end bits with low data quality for flux = 3
                           # first year and probably the last
                           plot(data$NEE_VUT_REF_QC, type="l") # fluxes
                           data$TIMESTAMP_START[c(1,nrow(data))]
                           data <- subset(data, TIMESTAMP_START>=200801010000) # remove first year
                           data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year
                           # nyears:
                           nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.30)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.25, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.30)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.30)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.20)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)

### Multi-year calculation ##
neps <- 500
0.8*mean(abs(data$WS_F[-nrow(data)]-data$WS_F[-1]), na.rm=T)
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.25,0.20,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[1])
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site


### Annual calculation ###
neps <- 500
0.8*mean(abs(data$WS_F[-nrow(data)]-data$WS_F[-1]), na.rm=T)
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- 200801010000 + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.02), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[7], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]) # rang=20% works well
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[1]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaP"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
res$date.ini <- as.numeric(paste(rep(c(2008:2012), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(2008:2012), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
season.dates <-function(st.date, nyears){
  yini <- as.numeric(substring(as.character(st.date), c(1), c(4)))
  yys <- rep(yini:(yini+(nyears-1)), each=4)
  mnt.ini <- rep(c("01010000", "04010000", "07010000", "10010000"), times=nyears)
  mnt.end <- rep(c("03312330", "06302330", "09302330", "12312330"), times=nyears)
  res <- data.frame(date.ini=as.numeric(paste(yys,mnt.ini, sep="")), date.end=as.numeric(paste(yys,mnt.end, sep="")))
  return(res)
}
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.02), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.07), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[6]), silent = T) # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# prec, season 6 fails continuously
# Check results
cd.list.season[[1]]$re # season 1, nee, etc...
cd.calc.plots(cd.list.season[[1]]$vpd)

# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaP"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
# cd.results$site  <- rbind(cd.results$site, data.site)
# cd.results$year <- rbind(cd.results$year, data.year)
# cd.results$season <- rbind(cd.results$season, data.season)
# cd.results <- list(site= data.site, year=data.year, season=data.season)
# save(cd.results, file="./cd_results.Rdata") # first save 17/05/2020
#
# cd.files <- list("AU-DaP"=list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season))
# save(cd.files, file="./cd_files.Rdata") # first save 17/05/2020

#### CDs: Site, Annual and Seasonal - AU-DaS site #2 ####
## AU-DaS
site.num <- 2
names(files)[site.num]
data <- files[[site.num]]
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Does not need removing years!
# Cut start and end bits with low data quality for flux = 3
# first year and probably the last
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# data$TIMESTAMP_START[c(1,nrow(data))]
# data <- subset(data, TIMESTAMP_START>=200801010000) # remove first year
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.30)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.30)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.30)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.30)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.25,0.25,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaS"
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- data$TIMESTAMP_START [1] + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[7], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]) # rang=20% works well
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a

cd.list.yr[[5]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- "AU-DaS"
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
res$date.ini <- as.numeric(paste(rep(c(2008:(2008+nyears-1)), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(2008:(2008+nyears-1)), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==25){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=25, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

#### CDs: Site, Annual and Seasonal - AU-How site #3 ####
## AU-DaS
site.num <- 3
names(files)[site.num]
data <- files[[site.num]]
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# Cut start and end bits with low data quality for flux = 3
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
data$TIMESTAMP_START[c(1,nrow(data))]
data <- subset(data, TIMESTAMP_START>=200201010000) # remove first year
# remove 2006? no
# data$TIMESTAMP_START[85000]
# a <- data$NEE_VUT_REF_QC
# a[which(data$TIMESTAMP_START<=200601010000|data$TIMESTAMP_START>=200701010000)] <- 0
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# lines(a, type="l", col="red") # fluxes
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year, no
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.25)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.25,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  st.date <- data$TIMESTAMP_START [1] + ((i-1)*000100000000)
  end.date <- st.date + 000100000000
  subdata <- subset(data, TIMESTAMP_START>=st.date&TIMESTAMP_END<end.date)
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[5]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- as.numeric(substring(as.character(data$TIMESTAMP_START[1]), c(1), c(4)))
res$date.ini <- as.numeric(paste(rep(c(year.ini:(year.ini+nyears-1)), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(c(year.ini:(year.ini+nyears-1)), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
st.date <- data$TIMESTAMP_START[1]
sea.dat <- season.dates(st.date, nyears)
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==25){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=25, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

#### CDs: Site, Annual and Seasonal - BE-Bra site #4 ####
## BE-Bra
site.num <- 4
names(files)[site.num]
data <- files[[site.num]]
## Add dates
date.fun <- function(date.fluxnet){
  return(as.numeric(substring(as.character(date.fluxnet), c(1,5,7,9,11), c(4,6,8,10,12))))
}
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# Cut start and end bits with low data quality for flux = 3
# first year and one of the middle ones
table(data$NEE_VUT_REF_QC, data$year)
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
data$TIMESTAMP_START[c(1,nrow(data))]
data <- subset(data, NEE_VUT_REF_QC>(-9999)) # remove missing data
data <- subset(data, year>=1999) # remove first year
table(data$year) # good, all days all years
# remove 2006? no
# data$TIMESTAMP_START[85000]
# a <- data$NEE_VUT_REF_QC
# a[which(data$TIMESTAMP_START<=200601010000|data$TIMESTAMP_START>=200701010000)] <- 0
# plot(data$NEE_VUT_REF_QC, type="l") # fluxes
# lines(a, type="l", col="red") # fluxes
# data <- subset(data, TIMESTAMP_START<=201212312330) # remove last year, no
# nyears:
nyears <- round(nrow(data)/(48*365), 1); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.20)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for VPD_F, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method


# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]) # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.4, prop.rang.min=0.4, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[13]]$vpd # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$temp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==24){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.4, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - BE-Vie site #5 ####
## BE-Vie
site.num <- 5
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- subset(data, year>1996) # remove missing data
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.25)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.25,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.28*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for VPD_F, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method


# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])
  yr.cd.nee <- cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]) # rang=20% works well
  yr.cd.gpp <- cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]) # rang=20% works well
  yr.cd.re <- cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]) # rang=20% works well
  if (i == 11){yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4])} else {
    yr.cd.temp <- cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4])} # rang=20% works well
  yr.cd.ws <- cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]) # rang=20% works well
  yr.cd.prec <- cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]) # rang=20% works well
  yr.cd.vpd <- cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7])
  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
cd.list.yr[[1]]$vpd # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[11]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}
  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}
  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==33|i==72){cd.re <- cd.nee
    cd.re$rsq.method [,] <- 0
    cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}
  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.07), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}
  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}
  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}
  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}
  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Gro site #6 ####
## BE-Vie
site.num <- 6
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- subset(data, year>2003) # remove low quality years
data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.25)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.18)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.25,0.18,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[1]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Man site #7 ####
## BE-Vie
site.num <- 7
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1994,2004,2005,2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.25,0.3,0.2,0.20,0.25,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[4]]$re)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])
  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if (i == 39){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Oas site #8 ####
## CA-Oas
site.num <- 8
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.2)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.2,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[12]]$re)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i == 23){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if (i == 7){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) } else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if (i==7){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) } else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-Qfo site #9 ####
## CA-Oas
site.num <- 9
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2003)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.4)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.4,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i==7){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.18), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP1 site #10 ####
## CA-TP1
site.num <- 10
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002,2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.2)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.2,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.3*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.3*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if(i==39){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(i==39){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[2]]$re # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[1]]$re)
# extract results (starting in two - season 1 failed)
for (i in 2:seasons){
  if(i==2){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i-1] <- rownames(res.gpp)[i-1] <- rownames(res.re)[i-1] <- rownames(res.temp)[i-1] <- rownames(res.ws)[i-1] <- rownames(res.prec)[i-1] <- rownames(res.vpd)[i-1] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=(seasons-1))
res$date.ini <- rep(sea.dat$date.ini[-1], times=7)
res$date.end <- rep(sea.dat$date.end[-1], times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP3 site #11 ####
## CA-TP3
site.num <- 11
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002, 2006, 2007)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
# rng <- c(0.25, 0.3,0.3,0.2,0.20,0.25,0.25)
# eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[3], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if (i == 23|i==27|i==31){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i == 27|i==28|i==34|i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if (i == 38){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CA-TP4 site #12 ####
## CA-TP4
site.num <- 12
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2002)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.4)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.25)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.4,0.3,0.2,0.2,0.25,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==3|i==4){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- 0
    yr.cd.re$dens.method [,] <- 0} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.2), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Cha site #13 ####
## CH-Cha
site.num <- 13
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005, 2009)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.4)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.4,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[1], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[5]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Dav site #14 ####
## CH-Dav
site.num <- 14
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.35)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.35,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i==65){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Fru site #15 ####
## CH-Fru
site.num <- 15
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2005,2006, 2009)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  if(i == 19){cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} else {
    cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T)} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CH-Lae site #16 ####
## CH-Lae
site.num <- 16
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2004)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.05, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.15, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i==3){my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CZ-BK1 site #17 ####
## CZ-BK1
site.num <- 17
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2004)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==6|i==9|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(i==8|i==12|i==16|i==24|i==25|i==32){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=40, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - CZ-wet site #18 ####
## CZ-wet
site.num <- 18
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.25,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Gri site #19 ####
## DE-Gri
site.num <- 19
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.25)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.20)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.25,0.2,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$prec # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$re)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Hai site #20 ####
## DE-Hai
site.num <- 20
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2006)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau=15, delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i == 3){ my.cd <- cd.mfm(data[,vars[i]], tau=15, delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Lnf site #21 ####
## DE-Lnf
site.num <- 21
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2002)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i == 3){ my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DE-Tha site #22 ####
## DE-Tha
site.num <- 22
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if (i == 3) {my.cd <- cd.mfm(data[,vars[i]], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) } else {
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$gpp)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - DK-Sor site #23 ####
## DK-Sor
site.num <- 23
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996,2014)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=34, delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==33|i==72){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.10), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - ES-LJu site #24 ####
## ES-LJu
site.num <- 24
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2004,2005)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if (i ==7){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  if(i==16){cd.re <- cd.nee
    cd.re$rsq.method [,] <- 0
    cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
    cd.vpd$rsq.method [,] <- 0
    cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FI-Hyy site #25 ####
## FI-Hyy
site.num <- 25
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang=0.4*neps)
# cd.list$GPP_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$GPP_DT_VUT_REF$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if (i == 72| i==44){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) } else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FI-Sod site #26 ####
## FI-Sod
site.num <- 26
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1996)),] # remove low quality years
# data <- subset(data, year>2003) # remove low quality years
# data <- subset(data, year<2014) # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears


# draw attractors for figures (check embedding dimension in test code below) #
# GPP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$GPP_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=24, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=24, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=24, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=24, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# NEP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$NEE_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=14, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=14, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=14, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=14, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# Re
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$RECO_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.35)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.35, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  if(i==15|i==51|i==55){cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} else {
    cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T)} # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(i==45){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else { # rang=20% works well
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-Fon site #27 ####
## FR-Fon
site.num <- 27
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2005,2014)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(i==3){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau=30, delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) } else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} # rang=20% works well
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[6]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  # if(i==16){cd.re <- cd.nee
  # cd.re$rsq.method [,] <- 0
  # cd.re$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}}

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  # if(i ==7|i ==13|i ==16|i ==19|i ==23){cd.vpd <- cd.nee
  # cd.vpd$rsq.method [,] <- 0
  # cd.vpd$dens.method [,] <- 0} # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-LBr site #28 ####
## FR-LBr
site.num <- 28
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996,1998,1999,2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# draw attractors for figures (check embedding dimension in test code below) #
# GPP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$GPP_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=13, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=13, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=13, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=13, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# NEP
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$NEE_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=13, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=13, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=13, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=13, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# Re
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$RECO_DT_VUT_REF[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)



# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$NEE_VUT_REF[1:(48*365)], lag=13, type = "p")
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.25, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.25, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  # if(i==3){yr.cd.nee <- g
  # yr.cd.gpp <- g
  # yr.cd.re <- g
  # yr.cd.temp <- g
  # yr.cd.ws <- g
  # yr.cd.prec <- g
  # yr.cd.vpd <- g
  #
  # yr.cd.nee$rsq.method [,] <- NA
  # yr.cd.nee$dens.method [,] <- NA
  #
  # yr.cd.gpp$rsq.method [,] <- NA
  # yr.cd.gpp$dens.method [,] <- NA
  #
  # yr.cd.re$rsq.method [,] <- NA
  # yr.cd.re$dens.method [,] <- NA
  #
  # yr.cd.temp$rsq.method [,] <- NA
  # yr.cd.temp$dens.method [,] <- NA
  #
  # yr.cd.ws$rsq.method [,] <- NA
  # yr.cd.ws$dens.method [,] <- NA
  #
  # yr.cd.prec$rsq.method [,] <- NA
  # yr.cd.prec$dens.method [,] <- NA
  #
  # yr.cd.vpd$rsq.method [,] <- NA
  # yr.cd.vpd$dens.method [,] <- NA
  # } else {

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[2], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - FR-Pue site #29 ####
## FR-Pue
site.num <- 29
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.25)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Col site #30 ####
## IT-Col
site.num <- 30
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1996, 1999,2002,2003,2004,2006)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Cpz site #31 ####
## IT-Cpz
site.num <- 31
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Lav site #32 ####
## IT-Lav
site.num <- 32
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    if (i==2|i==5|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
      yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T) # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-MBo site #33 ####
## IT-MBo
site.num <- 33
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(1997,2000, 1998,1999,2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if(i==2){yr.cd.gpp <-  yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==32){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Noe site #34 ####
## IT-Noe
site.num <- 34
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2004,2011)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ren site #35 ####
## IT-Ren
site.num <- 35
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(1998,2000,2001,2004)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ro1 site #36 ####
## IT-Ro1
site.num <- 36
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2000,2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Ro2 site #37 ####
## IT-Ro2
site.num <- 37
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-SRo site #38 ####
## IT-SRo
site.num <- 38
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$NEE_VUT_REF_QC==(-9999)),] # remove low quality years
# data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    if (i==12){yr.cd.gpp <- yr.cd.nee
      yr.cd.gpp$rsq.method [,] <- NA
      yr.cd.gpp$dens.method [,] <- NA} else {
      yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
    }}
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - IT-Tor site #39 ####
## IT-Tor
site.num <- 39
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - NL-Hor site #40 ####
## NL-Hor
site.num <- 40
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2006,2011)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang=0.35*neps)
# cd.list$RECO_DT_VUT_REF$rsq.method  <- a$rsq.method[1,]
# cd.list$RECO_DT_VUT_REF$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==2){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      if (i==19){cd.re <- cd.nee
        cd.re$rsq.method [,] <- NA
        cd.re$dens.method [,] <- NA} else {
        cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}}} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - NL-Loo site #41 ####
## NL-Loo
site.num <- 41
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1996)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - RU-Fyo site #42 ####
## RU-Fyo
site.num <- 42
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1998)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears


# draw attractors for figures (check embedding dimension in test code below) #
# temp
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$TA_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=28, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=28, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=28, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=28, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# prec
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$P_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=10, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=10, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=10, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=10, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# vpd
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$VPD_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=26, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=26, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=26, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=26, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# ws
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$WS_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=35, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=35, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=35, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=35, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)



# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])


  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T) # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Blo site #43 ####
## US-Blo
site.num <- 43
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1997,1998,1999,2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T) # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==27){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Los site #44 ####
## US-Los
site.num <- 44
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000,2007,2008,2009,2010,2011,2012,2013)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if (i==1){cd.gpp <- cd.nee
      cd.gpp$rsq.method [,] <- NA
      cd.gpp$dens.method [,] <- NA} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} # rang=20% works well
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==27){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
    if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}
  }

  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[23]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Me3 site #45 ####
## US-Me3
site.num <- 45
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2009)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==6){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-NR1 site #46 ####
## US-NR1
site.num <- 46
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(1998,1999)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  if(i==3){my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} else{
    my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i])} # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    if(i==7|i==8|i==10|i==11){yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)} else {
      yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  }
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if(i==39){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  }
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Oho site #47 ####
## US-Oho
site.num <- 47
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(1998,1999)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRC site #48 ####
## US-SRC
site.num <- 48
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008,2013,2014)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.15)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRG site #49 ####
## US-SRG
site.num <- 49
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-SRM site #50 ####
## US-SRM
site.num <- 50
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
# data <- data[-which(data$year%in%c(2008)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# draw attractors for figures (check embedding dimension in test code below) #
# temp
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$TA_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=29, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=29, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=29, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=29, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# prec
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$P_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=6, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=6, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=6, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=6, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# vpd
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$VPD_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=29, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=29, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=29, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=29, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# ws
cls <- c(rep("blue", times=17520/4), rep("red", times=17520/4), rep("yellow", times=17520/4), rep("grey20", times=17520/4))
vrs <- predict(loess(data$WS_F[1:(48*365)]~c(1:17520), span = 48/17520))
atrc <- data.frame(vrs, cls)
attract(atrc$vrs[1:4380], lag=21, type = "l", col = as.character(atrc$cls[1:4380]), add=F,
        xlim = range(atrc$vrs)*1.01, ylim=range(atrc$vrs)*1.01, zlim=range(atrc$vrs)*1.01,
        phi=20, theta=40, alpha=0.3)
attract(atrc$vrs[4381:8760], lag=21, type = "l", col = as.character(atrc$cls[4381:8760]), add=T, alpha=0.3)
attract(atrc$vrs[8761:13140], lag=21, type = "l", col = as.character(atrc$cls[8761:13140]), add=T, alpha=0.3)
attract(atrc$vrs[13141:17520], lag=21, type = "l", col = as.character(atrc$cls[13141:17520]), add=T, alpha=0.3)


# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.2)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==38){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }} # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Syv site #51 ####
## US-Syv
site.num <- 51
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2001,2007,2008,2009,2010,2011,2012)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.2)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} # rang=20% works well
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  } # rang=20% works well
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Ton site #52 ####
## US-Ton
site.num <- 52
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2001)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==23|i==35){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- NA
      cd.prec$dens.method [,] <- NA} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Var site #53 ####
## US-Var
site.num <- 53
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if (i==39|i==31){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- NA
      cd.prec$dens.method [,] <- NA} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-WCr site #54 ####
## US-WCr
site.num <- 54
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2007,2008,2009,2010)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.3)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.3)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  }
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Whs site #55 ####
## US-Whs
site.num <- 55
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2007)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if(i==14){cd.gpp <- cd.nee
      cd.gpp$rsq.method [,] <- NA
      cd.gpp$dens.method [,] <- NA} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
    }}
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
  }
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - US-Wkg site #56 ####
## US-Wkg
site.num <- 56
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2004)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
# a <- cd.calc(cd.list$VPD_F$param$scal.exp, rang=0.35*neps)
# cd.list$VPD_F$rsq.method  <- a$rsq.method[1,]
# cd.list$VPD_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[5], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA} else {
    if(i==6){cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.15), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)} else {
      cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
    }}
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else{
    if(i==4|i==26|i==34){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### CDs: Site, Annual and Seasonal - ZA-Kru site #57 ####
## ZA-Kru
site.num <- 57
names(files)[site.num]
data <- files[[site.num]]
## Add dates
a <- Sys.time()
ddates <- t(apply(data.frame(data$TIMESTAMP_START), 1, date.fun))
Sys.time()-a
colnames(ddates) <- c("year", "month", "day", "hour", "min")
# merge good dates with data
data <- cbind(data, ddates)
# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC, data$year)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD
# Removing first year
# first year and one of the middle ones
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
table(data$NEE_VUT_REF_QC, data$year)
data <- data[-which(data$year%in%c(2000,2006,2013)),] # remove low quality years
table(data$NEE_VUT_REF_QC, data$year)
table(data$year) # good, all days all years
# nyears:
nyears <- length(unique(data$year)); nyears

# 1 test per variable to tune parameters, rang, eps.min, etc...
attract(data$TA_F[1:(48*365)], lag=5)
neps <- 500
a <- cd.mfm(data$NEE_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(a$param$scal.exp, rang=neps*0.3)
b <- cd.mfm(data$GPP_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(b$param$scal.exp, rang=neps*0.3)
c <- cd.mfm(data$RECO_DT_VUT_REF[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(c$param$scal.exp, rang=neps*0.3)
d <- cd.mfm(data$TA_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(d$param$scal.exp, rang=neps*0.2)
e <- cd.mfm(data$WS_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(e$param$scal.exp, rang=neps*0.2)
f <- cd.mfm(data$P_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(f$param$scal.exp, rang=neps*0.3)
g <- cd.mfm(data$VPD_F[1:(48*365)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.3, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
# g <- cd.mfm(data$VPD_F[1:(48*90)], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.1, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01) # rang=20% works well
cd.calc(g$param$scal.exp, rang=neps*0.25)


### Multi-year calculation ##
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.2,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=7)
a <- Sys.time()
a
cd.list <-foreach(i=c(1:7)) %dopar% {
  my.cd <- cd.mfm(data[,vars[i]], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[i], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[i]) # rang=20% works well
  return(
    my.cd
  )
}
Sys.time()-a
length(cd.list)
names(cd.list) <- vars
# visual check
cd.calc.plots(cd.list$NEE_VUT_REF)
cd.calc.plots(cd.list$GPP_DT_VUT_REF) # a bit bad
# cd.calc(cd.list$GPP_DT_VUT_REF$param$scal.exp, rang = 0.4*neps) # good, equal result
cd.calc.plots(cd.list$RECO_DT_VUT_REF) # a bit bad but ok
# cd.calc(cd.list$RECO_DT_VUT_REF$param$scal.exp, rang = 0.35*neps) # good, equal result
cd.calc.plots(cd.list$TA_F) #
cd.calc.plots(cd.list$WS_F)
cd.calc.plots(cd.list$P_F)
cd.calc.plots(cd.list$VPD_F)
# No saturation for GPP_DT_VUT_REF, recalculate and add to cd.list$VPD_F
# a <- cd.calc(cd.list$P_F$param$scal.exp, rang=0.4*neps)
# cd.list$P_F$rsq.method  <- a$rsq.method[1,]
# cd.list$P_F$dens.method <- a$dens.method
a <- cd.calc(cd.list$WS_F$param$scal.exp, rang=0.35*neps)
cd.list$WS_F$rsq.method  <- a$rsq.method[1,]
cd.list$WS_F$dens.method <- a$dens.method

# cd.list$TA_F$param$scal.exp
# extract results
for (i in 1:length(cd.list)){
  res.nee<- summary.cd.calc(cd.list$NEE_VUT_REF)[1,]
  res.gpp<- summary.cd.calc(cd.list$GPP_DT_VUT_REF)[1,]
  res.re<- summary.cd.calc(cd.list$RECO_DT_VUT_REF)[1,]
  res.temp<- summary.cd.calc(cd.list$TA_F)[1,]
  res.ws<- summary.cd.calc(cd.list$WS_F)[1,]
  res.prec<- summary.cd.calc(cd.list$P_F)[1,]
  res.vpd<- summary.cd.calc(cd.list$VPD_F)[1,]
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- c("nee", "gpp", "re", "temp", "prec", "ws", "vpd")
res$time.steps <- nrow(data)
res$years <- nyears
data.site <- res[, c(16:19,1:15)]
data.site

### Annual calculation ###
neps <- 500
vars <- c("NEE_VUT_REF", "GPP_DT_VUT_REF", "RECO_DT_VUT_REF", "TA_F", "WS_F", "P_F", "VPD_F")
rng <- c(0.3, 0.3,0.3,0.2,0.25,0.3,0.25)
eps.mins <- c(0.01,0.01,0.01,0.01,0.01,0.01,0.01)


# parallel foreach
library (parallel)
library (snow)
library (doParallel)
registerDoParallel(cores=nyears)
a <- Sys.time()
a
cd.list.yr <-foreach(i=c(1:nyears)) %dopar% {
  subdata <- subset(data, year==unique(data$year)[i])

  yr.cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent=T) # rang=20% works well
  if(class(yr.cd.nee)=="try.error"){yr.cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){yr.cd.gpp <- yr.cd.nee
    yr.cd.gpp$rsq.method [,] <- NA
    yr.cd.gpp$dens.method [,] <- NA} else {
    yr.cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = (neps*rng[2]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent=T) # rang=20% works well
  }
  if(class(yr.cd.gpp)=="try.error"){yr.cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){yr.cd.re <- yr.cd.nee
    yr.cd.re$rsq.method [,] <- NA
    yr.cd.re$dens.method [,] <- NA} else {
    yr.cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent=T)}
  if(class(yr.cd.re)=="try.error"){yr.cd.re <- "fail!"}

  yr.cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[4], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent=T) # rang=20% works well
  if(class(yr.cd.temp)=="try.error"){yr.cd.temp <- "fail!"}

  yr.cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.e.decay", rang = (neps*rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent=T) # rang=20% works well
  if(class(yr.cd.ws)=="try.error"){yr.cd.ws <- "fail!"}

  yr.cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*rng[6], neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent=T) # rang=20% works well
  if(class(yr.cd.prec)=="try.error"){yr.cd.prec <- "fail!"}

  yr.cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent=T)
  if(class(yr.cd.vpd)=="try.error"){yr.cd.vpd <- "fail!"}

  return(yr.cd=list("nee"=yr.cd.nee, "gpp"=yr.cd.gpp,
                    "re"=yr.cd.re, "temp"=yr.cd.temp,
                    "ws"=yr.cd.ws, "prec"=yr.cd.prec, "vpd"=yr.cd.vpd))
}
Sys.time()-a
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:nyears){
  f.nee [i] <- ifelse(class(cd.list.yr[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.yr[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.yr[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.yr[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.yr[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.yr[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.yr[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)

cd.list.yr[[1]]$nee # year 1, nee, etc...
cd.calc.plots(cd.list.yr[[3]]$nee)


# extract results
for (i in 1:length(cd.list.yr)){
  if(i==1){res.nee<- summary.cd.calc(cd.list.yr[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.yr[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.yr[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.yr[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.yr[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.yr[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.yr[[i]]$vpd)[1,]} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.yr[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.yr[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.yr[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.yr[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.yr[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.yr[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.yr[[i]]$vpd)[1,])
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files)[site.num]
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=nyears)
# Change year
year.ini <- unique(data$year)[1]
res$date.ini <- as.numeric(paste(rep(unique(data$year), times=7), c("01010000"), sep=""))
res$date.end <- as.numeric(paste(rep(unique(data$year), times=7), c("12312330"), sep=""))
# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}
data.year <- res[, c(16:22,1:15)]
# View(data.year)



### Seasonal calculation ###
neps <- 500
seasons <- nyears*4
# 1 season = 3 months: winter: january, february, march, spring:...
#

# parallel foreach
library (parallel)
library (snow)
library (doParallel)
# go for seasons not years
sea.dat <- season.dates.yrs(unique(data$year))
registerDoParallel(cores=seasons)
a <- Sys.time()
a
cd.list.season <-foreach(i=c(1:seasons)) %dopar% {
  subdata <- subset(data, TIMESTAMP_START>=sea.dat[i,"date.ini"]&TIMESTAMP_START<=sea.dat[i,"date.end"])

  cd.nee <- try(cd.mfm(subdata[,"NEE_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[1]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[1]), silent = T) # rang=20% works well
  if(class(cd.nee)=="try.error"){cd.nee <- "fail!"}

  if(sd(subdata[,"GPP_DT_VUT_REF"], na.rm=T)==0){cd.gpp <- cd.nee
    cd.gpp$rsq.method [,] <- NA
    cd.gpp$dens.method [,] <- NA}  else {
    cd.gpp <- try(cd.mfm(subdata[,"GPP_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[2]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[2]), silent = T)
  }
  if(class(cd.gpp)=="try.error"){cd.gpp <- "fail!"}

  if(sd(subdata[,"RECO_DT_VUT_REF"], na.rm=T)==0){cd.re <- cd.nee
    cd.re$rsq.method [,] <- NA
    cd.re$dens.method [,] <- NA} else {
    if (i==22){cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)} else {
      cd.re <- try(cd.mfm(subdata[,"RECO_DT_VUT_REF"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[3]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[3]), silent = T)
    }}
  if(class(cd.re)=="try.error"){cd.re <- "fail!"}

  cd.temp <- try(cd.mfm(subdata[,"TA_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[4]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[4]), silent = T) # rang=20% works well
  if(class(cd.temp)=="try.error"){cd.temp <- "fail!"}

  if(sd(subdata[,"P_F"], na.rm=T)==0){cd.prec <- cd.nee
    cd.prec$rsq.method [,] <- 0
    cd.prec$dens.method [,] <- 0} else {
    if(i==27|i==30|i==31|i==35){cd.prec <- cd.nee
      cd.prec$rsq.method [,] <- 0
      cd.prec$dens.method [,] <- 0} else {
      cd.prec <- try(cd.mfm(subdata[,"P_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[6]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[6]), silent = T)
    }}
  if(class(cd.prec)=="try.error"){cd.prec <- "fail!"}


  cd.ws <- try(cd.mfm(subdata[,"WS_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[5]-0.05), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[5]), silent = T) # rang=20% works well
  if(class(cd.ws)=="try.error"){cd.ws <- "fail!"}

  cd.vpd <- try(cd.mfm(subdata[,"VPD_F"], tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*(rng[7]-0.1), neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=eps.mins[7]), silent = T) # rang=20% works well
  if(class(cd.vpd)=="try.error"){cd.vpd <- "fail!"}

  return(season.cd=list("nee"=cd.nee, "gpp"=cd.gpp,
                        "re"=cd.re, "temp"=cd.temp,
                        "ws"=cd.ws, "prec"=cd.prec, "vpd"=cd.vpd))
}
Sys.time()-a
names(cd.list.season) <- sea.dat$date.ini # names are seasons start dates
# which ones fail?
f.nee <- character(); f.gpp <- character(); f.re<- character(); f.temp<- character(); f.prec<- character();
f.ws <- character(); f.vpd<- character()
for (i in 1:seasons){
  f.nee [i] <- ifelse(class(cd.list.season[[i]]$nee)=="try-error", yes = "error", no="ok")
  f.gpp [i] <- ifelse(class(cd.list.season[[i]]$gpp)=="try-error", yes = "error", no="ok")
  f.re  [i] <- ifelse(class(cd.list.season[[i]]$re)=="try-error", yes = "error", no="ok")
  f.temp [i] <- ifelse(class(cd.list.season[[i]]$temp)=="try-error", yes = "error", no="ok")
  f.prec [i] <- ifelse(class(cd.list.season[[i]]$prec)=="try-error", yes = "error", no="ok")
  f.ws [i] <- ifelse(class(cd.list.season[[i]]$ws)=="try-error", yes = "error", no="ok")
  f.vpd [i] <- ifelse(class(cd.list.season[[i]]$vpd)=="try-error", yes = "error", no="ok")
}
data.frame(f.nee, f.gpp, f.re, f.temp, f.prec, f.ws, f.vpd)
# Check results
cd.list.season[[23]]$nee # if $rsq.method and dens.method == 0's, prec were all 0's.
cd.calc.plots(cd.list.season[[20]]$nee)
# extract results
for (i in 1:seasons){
  if(i==1){res.nee<- summary.cd.calc(cd.list.season[[i]]$nee)[1,]
    res.gpp<- summary.cd.calc(cd.list.season[[i]]$gpp)[1,]
    res.re<- summary.cd.calc(cd.list.season[[i]]$re)[1,]
    res.temp<- summary.cd.calc(cd.list.season[[i]]$temp)[1,]
    res.ws<- summary.cd.calc(cd.list.season[[i]]$ws)[1,]
    res.prec<- summary.cd.calc(cd.list.season[[i]]$prec)[1,]
    res.vpd<- summary.cd.calc(cd.list.season[[i]]$vpd)[1,]
    rownames(res.nee) <- rownames(res.gpp) <- rownames(res.re) <- rownames(res.temp) <- rownames(res.ws) <- rownames(res.prec) <- rownames(res.vpd) <- paste("season",i,sep=".")} else {
    res.nee<- rbind(res.nee, summary.cd.calc(cd.list.season[[i]]$nee)[1,])
    res.gpp<- rbind(res.gpp,summary.cd.calc(cd.list.season[[i]]$gpp)[1,])
    res.re<- rbind(res.re,summary.cd.calc(cd.list.season[[i]]$re)[1,])
    res.temp<- rbind(res.temp,summary.cd.calc(cd.list.season[[i]]$temp)[1,])
    res.ws<- rbind(res.ws,summary.cd.calc(cd.list.season[[i]]$ws)[1,])
    res.prec<- rbind(res.prec,summary.cd.calc(cd.list.season[[i]]$prec)[1,])
    res.vpd<- rbind(res.vpd,summary.cd.calc(cd.list.season[[i]]$vpd)[1,])
    rownames(res.nee)[i] <- rownames(res.gpp)[i] <- rownames(res.re)[i] <- rownames(res.temp)[i] <- rownames(res.ws)[i] <- rownames(res.prec)[i] <- rownames(res.vpd)[i] <- paste("season",i,sep=".")
  }
}
res <- round(rbind(res.nee, res.gpp, res.re, res.temp, res.prec, res.ws, res.vpd), 3)
rownames(res)<- NULL
res$site <- names(files[site.num])
res$var <- rep(c("nee", "gpp", "re", "temp", "prec", "ws", "vpd"), each=seasons)
res$date.ini <- rep(sea.dat$date.ini, times=7)
res$date.end <- rep(sea.dat$date.end, times=7)

# Add mean flux and weather data per season
res$var.sums <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$var.means <- NA # sum for nee, gpp re, and prec, mean for temp, ws, and vpd
res$time.steps <- NA
for (i in 1:nrow(res)){
  if(res$var[i]=="nee"){
    res$var.sums [i] <- sum(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$NEE_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="gpp"){
    res$var.sums [i] <- sum(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$GPP_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="re"){
    res$var.sums [i] <- sum(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$RECO_DT_VUT_REF[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="temp"){
    res$var.sums [i] <- sum(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$TA_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="prec"){
    res$var.sums [i] <- sum(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$P_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="ws"){
    res$var.sums [i] <- sum(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$WS_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
  if(res$var[i]=="vpd"){
    res$var.sums [i] <- sum(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$var.means [i] <- mean(data$VPD_F[which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i])], na.rm=T)
    res$time.steps [i] <- length (which(data$TIMESTAMP_START>=res$date.ini[i]&data$TIMESTAMP_START<=res$date.end[i]))
  }
}

data.season <- res[, c(16:22,1:15)]
View(data.season) # ok

# save result tables for year and seasonal CDs
# if site is not AU-DaP = first
load(file="./cd_results.Rdata") #
cd.results$site  <- rbind(cd.results$site, data.site)
cd.results$year <- rbind(cd.results$year, data.year)
cd.results$season <- rbind(cd.results$season, data.season)
save(cd.results, file="./cd_results.Rdata") # first save 19/05/2020
# Save object files
load(file="./cd_files.Rdata")
cd.files [[site.num]] <- list("site"=cd.list, "annual"=cd.list.yr, "season"=cd.list.season)
names(cd.files)[site.num] <- names(files[site.num])
save(cd.files, file="./cd_files.Rdata") # first save 19/05/2020

unique(cd.results$site$site)
unique(cd.results$year$site)
unique(cd.results$season$site)

#### Cleaning results D2 ####
load(file="./cd_results.Rdata") #
### Code results: ###
# d2: last 5 embedding dimensions method max R2 - min PV
# d2.minslope: 5 embedding dimensions with minimum slope using method max R2 - min PV
# dens.d2: most frequent D2 across dimensions, method max R2 - min PV
# cd.dens.single: most frequent slope using kernel density estiamtions per embedding dimenison
# cd.dens.overall: most frequent slope using kernel density estimation across embedding dimensions
### ### ### ### ### ###

# visual check
boxplot(d2~var, data=cd.results$site)
boxplot(d2.minslope~var, data=cd.results$site)
boxplot(dens.d2~var, data=cd.results$site)
boxplot(cd.dens.single~var, data=cd.results$site)
boxplot(cd.dens.overall~var, data=cd.results$site) # completely different

# Correlation is very good (overall series)
plot(d2~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$d2.minslope)

plot(d2~dens.d2, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$dens.d2)

plot(dens.d2~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$dens.d2,cd.results$site$d2.minslope)

# check with density
plot(d2~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$d2,cd.results$site$cd.dens.single)

plot(dens.d2~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$dens.d2,cd.results$site$cd.dens.single)

plot(d2.minslope~cd.dens.single, data=cd.results$site)
cor.test(cd.results$site$d2.minslope,cd.results$site$cd.dens.single)

## SITE - Compute minium difference D2 (max R2 - min PV) ##
mnd2 <- function(a,b,c, ase, bse, cse){
  if (any(is.na(c(a, b, c)))){return(list(res=NA,d2=NA, d2se=NA))} else {
    ab <- abs(a-b)
    ac <- abs(a-c)
    bc <- abs(b-c)
    rs <- data.frame(comp=c("ab", "ac", "bc"), dif=c(ab, ac, bc), d2=round(c(mean(c(a,b)),mean(c(a,c)), mean(c(b,c))),digit=2),
                     d2se=c(sqrt(ase^2+bse^2),sqrt(ase^2+cse^2), sqrt(bse^2+cse^2)))
    return(list(res=rs, d2=rs$d2[which(rs$dif==min(rs$dif,na.rm=T))], d2se= rs$d2se[which(rs$dif==min(rs$dif,na.rm=T))]))}
}
# mnd2(4,6,5.5, 0.2, 0.3, 0.1) # works ok!
# mnd2(NA,6,5.5, NA, 0.3, 0.1) # works ok!
cd.results$site$d2.c <- NA
cd.results$site$d2.cse <- NA
for (i in 1:nrow(cd.results$site)){
  a <- mnd2(cd.results$site$d2[i], cd.results$site$d2.minslope[i], cd.results$site$dens.d2[i],
            cd.results$site$d2.se[i], cd.results$site$d2.minslope.se[i], cd.results$site$dens.d2[i]*((cd.results$site$pv[i])/100))
  cd.results$site$d2.c [i] <- a$d2
  cd.results$site$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$site)
plot(d2.c~d2, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$d2)
plot(d2.c~dens.d2, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$site)
cor.test(cd.results$site$d2.c,cd.results$site$d2.minslope)



## YEAR - Compute minium difference D2 (max R2 - min PV) ##
for (i in 1:nrow(cd.results$year)){
  a <- mnd2(cd.results$year$d2[i], cd.results$year$d2.minslope[i], cd.results$year$dens.d2[i],
            cd.results$year$d2.se[i], cd.results$year$d2.minslope.se[i], cd.results$year$dens.d2[i]*((cd.results$year$pv[i])/100))
  cd.results$year$d2.c [i] <- a$d2
  cd.results$year$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$year)
plot(d2.c~d2, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$d2)
plot(d2.c~dens.d2, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$year)
cor.test(cd.results$year$d2.c,cd.results$year$d2.minslope)


## season - Compute minium difference D2 (max R2 - min PV) ##
for (i in 1:nrow(cd.results$season)){
  a <- mnd2(cd.results$season$d2[i], cd.results$season$d2.minslope[i], cd.results$season$dens.d2[i],
            cd.results$season$d2.se[i], cd.results$season$d2.minslope.se[i], cd.results$season$dens.d2[i]*((cd.results$season$pv[i])/100))
  cd.results$season$d2.c [i] <- a$d2
  cd.results$season$d2.cse [i] <- a$d2se
}

# Correlation is very good (overall series), R>0.985
boxplot(d2.c~var, data=cd.results$season)
plot(d2.c~d2, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$d2)
plot(d2.c~dens.d2, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$dens.d2)
plot(d2.c~d2.minslope, data=cd.results$season)
cor.test(cd.results$season$d2.c,cd.results$season$d2.minslope)


## check and save ##
summary(cd.results$site)
summary(cd.results$year)
summary(cd.results$season)
save(cd.results, file="./cd_results.Rdata") # checked and saved corrected results 25/06/2020


#### TRENDS IN FLUX QUALITY ####
library (mblm)
yfun <- function(var){
  return(substr(var, 1, 4))
}
res.datqual <- data.frame(site.name=names(files), nee.q=NA, nee.q.pval=NA, temp.q=NA, temp.q.pval=NA)
job::job({for (i in 1:length(names(files))){
  data <- files[[i]]
  for (y in 1:nrow(data)){
    data$year[y] <- yfun(data$TIMESTAMP_START[y])
  }
  aux <- aggregate(data[,c("NEE_VUT_REF_QC","TA_F_QC")], by=list("year"=data$year), mean)
  aux$year <- as.numeric(aux$year)
  modnee <- mblm(NEE_VUT_REF_QC ~ year, data=aux)
  res.datqual$nee.q [i] <- modnee$coefficients[2]
  res.datqual$nee.q.pval [i] <- summary(modnee)$coefficients[2,4]
  modtemp <- mblm(TA_F_QC ~ year, data=aux)
  res.datqual$temp.q [i] <- modtemp$coefficients[2]
  res.datqual$temp.q.pval [i] <- summary(modtemp)$coefficients[2,4]
}})
save(res.datqual, file="./trends.datqual.Rdata")
median(res.datqual$nee.q)
hist(res.datqual$nee.q)

# Data quality flags
# 0 = measured; 1 = good quality gapfill; 2 = medium; 3 = poor
table(data$NEE_VUT_REF_QC)
# check data quality with time
plot(data$NEE_VUT_REF_QC, type="l") # fluxes
plot(data$TA_F_QC, type="l") # temperature
plot(data$P_F_QC, type="l") # precipitation
plot(data$WS_F_QC, type="l") # wind speed
plot(data$VPD_F_QC, type="l") # VPD




#### Graphs for fwllowshps ####
library (deSolve)
library (tseriesChaos)
library (fields)

par(mfrow=c(3,3))
# Graph 1 - sine wave
t=seq(0,50,0.1)
xy=sin(t)
plot(t,xy,type="l", xlab=NA, ylab="x(t)", las=1, lwd=2, col="blue")
# Graph 2 - Lorenz attractor
lorenz_results<-lorenz_udf(x0=1,y0=1,z0=1,sigma=10,beta=8/3,rho=28,
                           t.end=50,delta=0.01)
x<-lorenz_results[[1]]
plot(x[1:3000], type="l", lwd=2, ylab="x(t)", xlab=NA, las=1)
# Graph 3 - white noise
xt <- runif(500, 0, 1)
plot(xt[1:500],type="l", xlab=NA, ylab="x(t)", las=1, lwd=2, col="red")


## Attractor 1
attract(xy, 6, type="l", lwd = 2, col="blue")
## Attractor 2
attract(x[1:3000], 7, type="l", lwd = 2, col="black")
## Attractor 2
attract(xt[1:500], 2, type="l", lwd = 2, col="red")

# dimcorrs
t=seq(0,50,0.1)
xy=sin(t)
cd_fertakens(xy, m_max = 6)
cd_fertakens(x, m_max = 8)
cd_fertakens(xt, m_max = 6)
cd_fertakens(day.flux, d = 25, m_max = 12)

# test jena global daily flux (around 5 degrees of freedom) from read_jcarboscope.R
attract(day.flux[1:7000], 71, type="l", lwd = 2, col="red")
neps <- 500
jena.cd <- cd.mfm(day.flux, tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01)
cd.calc(jena.cd$param$scal.exp, rang=neps*0.25)

1,y0=1,z0=1,sigma=10,beta=8/3,rho=28,
                           t.end=50,delta=0.01)
x<-lorenz_results[[1]]
plot(x[1:3000], type="l", lwd=2, ylab="x(t)", xlab=NA, las=1)
# Graph 3 - white noise
xt <- runif(500, 0, 1)
plot(xt[1:500],type="l", xlab=NA, ylab="x(t)", las=1, lwd=2, col="red")


## Attractor 1
attract(xy, 6, type="l", lwd = 2, col="blue")
## Attractor 2
attract(x[1:3000], 7, type="l", lwd = 2, col="black")
## Attractor 2
attract(xt[1:500], 2, type="l", lwd = 2, col="red")

# dimcorrs
t=seq(0,50,0.1)
xy=sin(t)
cd_fertakens(xy, m_max = 6)
cd_fertakens(x, m_max = 8)
cd_fertakens(xt, m_max = 6)
cd_fertakens(day.flux, d = 25, m_max = 12)

# test jena global daily flux (around 5 degrees of freedom) from read_jcarboscope.R
attract(day.flux[1:7000], 71, type="l", lwd = 2, col="red")
neps <- 500
jena.cd <- cd.mfm(day.flux, tau="auto", delay.technique="ami", sel.method="first.minimum", rang = neps*0.2, neps=neps, prop.rang.max = 0.5, prop.rang.min=0.5, eps.min=0.01)
cd.calc(jena.cd$param$scal.exp, rang=neps*0.25)

